#!/bin/bash

# SnapSync v2.5 å¢å¼ºç‰ˆç³»ç»Ÿæ¢å¤å·¥å…·
# å®Œå…¨é€‚é…v2.5å¢å¼ºç‰ˆå¤‡ä»½è„šæœ¬çš„æ‰€æœ‰ç‰¹æ€§
# æ”¯æŒACLã€æ‰©å±•å±æ€§ã€å¤šç§å‹ç¼©æ ¼å¼ã€å®Œæ•´æ€§éªŒè¯

# ====================================================================
# åŸºç¡€æ£€æŸ¥å’Œåˆå§‹åŒ–
# ====================================================================

# æƒé™æ£€æŸ¥
if [ "$EUID" -ne 0 ]; then
    echo -e "\033[0;31mé”™è¯¯: è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬\033[0m"
    exit 1
fi

# é¢œè‰²è®¾ç½®
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[0;33m'
BLUE='\033[0;34m'; CYAN='\033[0;36m'; PURPLE='\033[0;35m'; NC='\033[0m'

# è·¯å¾„å®šä¹‰ (ä¸å¤‡ä»½è„šæœ¬å®Œå…¨ä¸€è‡´)
CONFIG_FILE="/etc/system_snapshot/config.conf"
LOG_DIR="/var/log/system_snapshot"
RESTORE_LOG_FILE="$LOG_DIR/restore.log"
DEBUG_LOG_FILE="$LOG_DIR/restore_debug.log"

# å…¨å±€å˜é‡
SCRIPT_VERSION="2.5"
RESTORE_TIMESTAMP=$(date +"%Y%m%d%H%M%S")
TEMP_DIR="/tmp/snapsync_restore_$$"
BACKUP_CONFIG_DIR="/tmp/current_config_backup_$$"
LOCK_FILE="/tmp/system_restore.lock"

# è¿›ç¨‹é”
exec 200>"$LOCK_FILE"
if ! flock -n 200; then
    echo -e "${RED}é”™è¯¯: æ¢å¤è„šæœ¬å·²åœ¨è¿è¡Œä¸­${NC}"
    exit 1
fi
echo $$ >&200

# æ¸…ç†å‡½æ•°
cleanup_on_exit() {
    log_debug "æ‰§è¡Œæ¸…ç†æ“ä½œ..."
    [ -d "$TEMP_DIR" ] && rm -rf "$TEMP_DIR"
    [ -d "$BACKUP_CONFIG_DIR" ] && rm -rf "$BACKUP_CONFIG_DIR"
    flock -u 200
}
trap 'cleanup_on_exit' EXIT INT TERM

# æ—¥å¿—å‡½æ•°
log() {
    mkdir -p "$LOG_DIR"
    echo -e "$(date '+%F %T') $1" | tee -a "$RESTORE_LOG_FILE"
}

log_debug() {
    mkdir -p "$LOG_DIR"
    echo -e "$(date '+%F %T') [DEBUG] $1" >> "$DEBUG_LOG_FILE"
}

log_error() {
    log "${RED}[ERROR] $1${NC}"
}

log_info() {
    log "${CYAN}[INFO] $1${NC}"
}

log_success() {
    log "${GREEN}[SUCCESS] $1${NC}"
}

log_warning() {
    log "${YELLOW}[WARNING] $1${NC}"
}

# å­—èŠ‚æ ¼å¼åŒ–å‡½æ•°
format_bytes() {
    local bytes="\$1"
    if [[ ! "$bytes" =~ ^[0-9]+$ ]]; then
        echo "0B"
        return
    fi
    
    if [ "$bytes" -ge 1073741824 ]; then
        echo "$((bytes / 1073741824)).$(((bytes % 1073741824) * 10 / 1073741824))GB"
    elif [ "$bytes" -ge 1048576 ]; then
        echo "$((bytes / 1048576)).$(((bytes % 1048576) * 10 / 1048576))MB"
    elif [ "$bytes" -ge 1024 ]; then
        echo "$((bytes / 1024)).$(((bytes % 1024) * 10 / 1024))KB"
    else
        echo "${bytes}B"
    fi
}

# Telegram é€šçŸ¥å‡½æ•°
send_telegram() {
    if [ -n "$BOT_TOKEN" ] && [ -n "$CHAT_ID" ]; then
        local rendered=$(printf "%b" "$1")
        curl -sS -m 15 "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" --data-urlencode text="$rendered" >/dev/null 2>&1 || true
    fi
}

# ====================================================================
# ç³»ç»Ÿè¦æ±‚æ£€æŸ¥
# ====================================================================

check_requirements() {
    log_info "æ£€æŸ¥ç³»ç»Ÿè¦æ±‚..."
    
    # åŸºç¡€å·¥å…·æ£€æŸ¥
    local required_tools="tar find xargs"
    local missing_tools=""
    
    for cmd in $required_tools; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing_tools="$missing_tools $cmd"
        fi
    done
    
    if [ -n "$missing_tools" ]; then
        log_error "ç¼ºå°‘å¿…éœ€å·¥å…·:$missing_tools"
        log_info "æ­£åœ¨å®‰è£…ç¼ºå¤±å·¥å…·..."
        apt-get update >/dev/null 2>&1
        for tool in $missing_tools; do
            apt-get install -y "$tool" >/dev/null 2>&1 || {
                log_error "æ— æ³•å®‰è£… $tool"
                return 1
            }
        done
    fi
    
    # å‹ç¼©å·¥å…·æ£€æŸ¥
    local compression_support=""
    command -v pigz >/dev/null 2>&1 && compression_support="$compression_support pigz"
    command -v gzip >/dev/null 2>&1 && compression_support="$compression_support gzip"
    command -v gunzip >/dev/null 2>&1 && compression_support="$compression_support gunzip"
    
    if [ -z "$compression_support" ]; then
        log_warning "æœªæ‰¾åˆ°å‹ç¼©å·¥å…·ï¼Œæ­£åœ¨å®‰è£…..."
        apt-get install -y gzip pigz >/dev/null 2>&1 || true
    fi
    
    # ACL å·¥å…·æ£€æŸ¥
    if ! command -v setfacl >/dev/null 2>&1; then
        log_info "å®‰è£… ACL å·¥å…·..."
        apt-get install -y acl >/dev/null 2>&1 || log_warning "ACL å·¥å…·å®‰è£…å¤±è´¥"
    fi
    
    # æ‰©å±•å±æ€§å·¥å…·æ£€æŸ¥
    if ! command -v setfattr >/dev/null 2>&1; then
        log_info "å®‰è£…æ‰©å±•å±æ€§å·¥å…·..."
        apt-get install -y attr >/dev/null 2>&1 || log_warning "æ‰©å±•å±æ€§å·¥å…·å®‰è£…å¤±è´¥"
    fi
    
    log_success "ç³»ç»Ÿè¦æ±‚æ£€æŸ¥å®Œæˆ"
    return 0
}

# ====================================================================
# é…ç½®åŠ è½½å’Œåˆå§‹åŒ–
# ====================================================================

load_config() {
    log_info "æ­£åœ¨åŠ è½½å¤‡ä»½å·¥å…·é…ç½®æ–‡ä»¶..."
    
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE" || {
            log_error "é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"
            return 1
        }
        log_success "é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ"
        
        # æ„å»ºå®Œæ•´è¿œç¨‹è·¯å¾„
        FULL_REMOTE_PATH="$TARGET_BASE_DIR/$REMOTE_DIR_NAME"
        log_debug "è¿œç¨‹è·¯å¾„: $FULL_REMOTE_PATH"
        
        return 0
    else
        log_warning "æœªæ‰¾åˆ°å¤‡ä»½é…ç½®æ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
        BACKUP_DIR="/backups"
        return 1
    fi
}

# ====================================================================
# ç”¨æˆ·ç•Œé¢
# ====================================================================

show_title() {
    clear
    echo -e "${BLUE}================================================================${NC}"
    echo -e "${BLUE}         SnapSync v${SCRIPT_VERSION} å¢å¼ºç‰ˆç³»ç»Ÿæ¢å¤å·¥å…·               ${NC}"
    echo -e "${BLUE}================================================================${NC}"
    echo -e "${CYAN}ç‰¹æ€§: ACLæ¢å¤ | æ‰©å±•å±æ€§ | å¤šæ ¼å¼æ”¯æŒ | å®Œæ•´æ€§éªŒè¯ | å¢é‡æ¢å¤${NC}"
    echo ""
}

show_restore_types() {
    echo -e "${CYAN}è¯·é€‰æ‹©æ¢å¤æ–¹å¼:${NC}"
    echo -e "1) ${GREEN}æœ¬åœ°æ¢å¤${NC} - ä»æœ¬åœ°å¤‡ä»½ç›®å½•æ¢å¤"
    echo -e "2) ${GREEN}è¿œç¨‹æ¢å¤${NC} - ä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½å¹¶æ¢å¤"
    echo -e "3) ${GREEN}æŒ‡å®šæ–‡ä»¶æ¢å¤${NC} - æŒ‡å®šå¿«ç…§æ–‡ä»¶è·¯å¾„æ¢å¤"
    echo ""
    
    while true; do
        read -p "è¯·é€‰æ‹© [1-3]: " RESTORE_TYPE
        if [[ "$RESTORE_TYPE" =~ ^[1-3]$ ]]; then
            break
        fi
        echo -e "${RED}é”™è¯¯: è¯·è¾“å…¥ 1-3 ä¹‹é—´çš„æ•°å­—${NC}"
    done
}

show_restore_modes() {
    echo -e "\n${YELLOW}æ¢å¤æ¨¡å¼é€‰æ‹©:${NC}"
    echo -e "1) ${GREEN}æ ‡å‡†æ¢å¤${NC} - ä¿ç•™ç½‘ç»œé…ç½®ã€SSHå¯†é’¥ã€ä¸»æœºåç­‰å…³é”®é…ç½®"
    echo -e "2) ${GREEN}å®Œå…¨æ¢å¤${NC} - æ¢å¤æ‰€æœ‰æ–‡ä»¶ï¼ˆå¯èƒ½å¯¼è‡´ç½‘ç»œé…ç½®ä¸¢å¤±ï¼‰"
    echo -e "3) ${GREEN}é€‰æ‹©æ€§æ¢å¤${NC} - ä»…æ¢å¤æŒ‡å®šç›®å½•"
    echo ""
    
    while true; do
        read -p "é€‰æ‹©æ¢å¤æ¨¡å¼ [1-3]: " RESTORE_MODE
        if [[ "$RESTORE_MODE" =~ ^[1-3]$ ]]; then
            break
        fi
        echo -e "${RED}é”™è¯¯: è¯·è¾“å…¥ 1-3 ä¹‹é—´çš„æ•°å­—${NC}"
    done
}

# ====================================================================
# å¿«ç…§æ–‡ä»¶æ£€æµ‹å’Œåˆ†æ
# ====================================================================

detect_snapshot_format() {
    local file="\$1"
    local format=""
    
    # æ£€æµ‹æ–‡ä»¶æ ¼å¼
    if [[ "$file" =~ \.tar\.gz$ ]] || [[ "$file" =~ \.tgz$ ]]; then
        format="gzip"
    elif [[ "$file" =~ \.tar\.bz2$ ]]; then
        format="bzip2"
    elif [[ "$file" =~ \.tar\.xz$ ]]; then
        format="xz"
    elif [[ "$file" =~ \.tar$ ]]; then
        format="uncompressed"
    else
        # é€šè¿‡æ–‡ä»¶å¤´æ£€æµ‹
        local file_type=$(file -b "$file" 2>/dev/null)
        if [[ "$file_type" =~ gzip ]]; then
            format="gzip"
        elif [[ "$file_type" =~ bzip2 ]]; then
            format="bzip2"
        elif [[ "$file_type" =~ XZ ]]; then
            format="xz"
        elif [[ "$file_type" =~ "POSIX tar" ]]; then
            format="uncompressed"
        else
            format="unknown"
        fi
    fi
    
    echo "$format"
}

get_decompression_cmd() {
    local format="\$1"
    
    case "$format" in
        "gzip")
            if command -v pigz >/dev/null 2>&1; then
                echo "pigz -dc"
            else
                echo "gunzip -c"
            fi
            ;;
        "bzip2")
            echo "bunzip2 -c"
            ;;
        "xz")
            echo "xz -dc"
            ;;
        "uncompressed")
            echo "cat"
            ;;
        *)
            echo ""
            ;;
    esac
}

verify_snapshot_integrity() {
    local snapshot_file="\$1"
    local checksum_file="${snapshot_file}.sha256"
    
    if [[ "$ENABLE_VERIFICATION" != "Y" ]]; then
        log_debug "è·³è¿‡å®Œæ•´æ€§éªŒè¯ï¼ˆæœªå¯ç”¨ï¼‰"
        return 0
    fi
    
    if [ ! -f "$checksum_file" ]; then
        log_warning "æœªæ‰¾åˆ°æ ¡éªŒå’Œæ–‡ä»¶ï¼Œè·³è¿‡å®Œæ•´æ€§éªŒè¯"
        return 0
    fi
    
    log_info "éªŒè¯å¿«ç…§å®Œæ•´æ€§..."
    if sha256sum -c "$checksum_file" >/dev/null 2>&1; then
        log_success "å¿«ç…§å®Œæ•´æ€§éªŒè¯é€šè¿‡"
        return 0
    else
        log_error "å¿«ç…§å®Œæ•´æ€§éªŒè¯å¤±è´¥"
        return 1
    fi
}

analyze_snapshot() {
    local snapshot_file="\$1"
    
    log_info "åˆ†æå¿«ç…§æ–‡ä»¶: $(basename "$snapshot_file")"
    
    # æ£€æµ‹æ ¼å¼
    local format=$(detect_snapshot_format "$snapshot_file")
    log_debug "æ£€æµ‹åˆ°æ ¼å¼: $format"
    
    if [ "$format" = "unknown" ]; then
        log_error "æ— æ³•è¯†åˆ«å¿«ç…§æ–‡ä»¶æ ¼å¼"
        return 1
    fi
    
    # è·å–è§£å‹å‘½ä»¤
    local decomp_cmd=$(get_decompression_cmd "$format")
    if [ -z "$decomp_cmd" ]; then
        log_error "ä¸æ”¯æŒçš„å‹ç¼©æ ¼å¼: $format"
        return 1
    fi
    
    # éªŒè¯å®Œæ•´æ€§
    if ! verify_snapshot_integrity "$snapshot_file"; then
        read -p "å®Œæ•´æ€§éªŒè¯å¤±è´¥ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ[y/N]: " continue_anyway
        if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    # åˆ†æå¿«ç…§å†…å®¹
    log_info "åˆ†æå¿«ç…§å†…å®¹..."
    local content_info=$(eval "$decomp_cmd '$snapshot_file' | tar -tv 2>/dev/null | head -20")
    log_debug "å¿«ç…§å†…å®¹é¢„è§ˆ:\n$content_info"
    
    # æ£€æŸ¥æ˜¯å¦åŒ…å«å¢å¼ºç‰¹æ€§
    local has_acl="å¦"
    local has_xattr="å¦"
    
    if eval "$decomp_cmd '$snapshot_file' | tar -tv 2>/dev/null | grep -q 'SCHILY.acl'"; then
        has_acl="æ˜¯"
    fi
    
    if eval "$decomp_cmd '$snapshot_file' | tar -tv 2>/dev/null | grep -q 'SCHILY.xattr'"; then
        has_xattr="æ˜¯"
    fi
    
    # æ˜¾ç¤ºå¿«ç…§ä¿¡æ¯
    local file_size=$(stat -c%s "$snapshot_file" 2>/dev/null || echo 0)
    local file_date=$(date -r "$snapshot_file" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "æœªçŸ¥")
    
    echo -e "\n${CYAN}å¿«ç…§åˆ†æç»“æœ:${NC}"
    echo -e "  æ–‡ä»¶å: $(basename "$snapshot_file")"
    echo -e "  å¤§å°: $(format_bytes $file_size)"
    echo -e "  æ—¥æœŸ: $file_date"
    echo -e "  æ ¼å¼: $format"
    echo -e "  ACLæ”¯æŒ: $has_acl"
    echo -e "  æ‰©å±•å±æ€§: $has_xattr"
    
    # ä¿å­˜åˆ†æç»“æœ
    SNAPSHOT_FORMAT="$format"
    SNAPSHOT_DECOMP_CMD="$decomp_cmd"
    SNAPSHOT_HAS_ACL="$has_acl"
    SNAPSHOT_HAS_XATTR="$has_xattr"
    
    return 0
}

# ====================================================================
# æœ¬åœ°æ¢å¤åŠŸèƒ½
# ====================================================================

local_restore() {
    echo -e "\n${BLUE}=== æœ¬åœ°æ¢å¤æ¨¡å¼ ===${NC}"
    
    if [ ! -d "$BACKUP_DIR" ]; then
        log_error "å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $BACKUP_DIR"
        return 1
    fi

    # æŸ¥æ‰¾æ‰€æœ‰æ”¯æŒçš„å¿«ç…§æ–‡ä»¶
    log_info "æœç´¢æœ¬åœ°å¿«ç…§æ–‡ä»¶..."
    local snapshot_patterns=("*.tar.gz" "*.tgz" "*.tar.bz2" "*.tar.xz" "*.tar")
    SNAPSHOT_FILES=()
    
    for pattern in "${snapshot_patterns[@]}"; do
        while IFS= read -r -d '' file; do
            SNAPSHOT_FILES+=("$file")
        done < <(find "$BACKUP_DIR" -maxdepth 1 -name "system_snapshot_*.$pattern" -print0 2>/dev/null)
    done
    
    # æŒ‰æ—¶é—´æ’åº
    if [ ${#SNAPSHOT_FILES[@]} -gt 0 ]; then
        IFS=$'\n' SNAPSHOT_FILES=($(printf '%s\n' "${SNAPSHOT_FILES[@]}" | sort -r))
    fi
    
    if [ ${#SNAPSHOT_FILES[@]} -eq 0 ]; then
        log_error "æœªæ‰¾åˆ°å¿«ç…§æ–‡ä»¶"
        echo -e "${YELLOW}æ”¯æŒçš„æ ¼å¼: .tar.gz, .tgz, .tar.bz2, .tar.xz, .tar${NC}"
        return 1
    fi

    # æ˜¾ç¤ºå¯ç”¨å¿«ç…§
    echo -e "\n${YELLOW}å‘ç° ${#SNAPSHOT_FILES[@]} ä¸ªæœ¬åœ°å¿«ç…§:${NC}"
    for i in "${!SNAPSHOT_FILES[@]}"; do
        local snapshot_name=$(basename "${SNAPSHOT_FILES[$i]}")
        local snapshot_size=$(stat -c%s "${SNAPSHOT_FILES[$i]}" 2>/dev/null || echo 0)
        local snapshot_date=$(date -r "${SNAPSHOT_FILES[$i]}" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "æœªçŸ¥")
        local format=$(detect_snapshot_format "${SNAPSHOT_FILES[$i]}")
        
        echo -e "$((i+1))) ${GREEN}$snapshot_name${NC}"
        echo -e "    å¤§å°: $(format_bytes $snapshot_size) | æ—¥æœŸ: $snapshot_date | æ ¼å¼: $format"
    done

    echo ""
    while true; do
        read -p "é€‰æ‹©å¿«ç…§ç¼–å· [1-${#SNAPSHOT_FILES[@]}]: " CHOICE
        if [[ "$CHOICE" =~ ^[0-9]+$ ]] && [ "$CHOICE" -ge 1 ] && [ "$CHOICE" -le ${#SNAPSHOT_FILES[@]} ]; then
            break
        fi
        echo -e "${RED}é”™è¯¯: è¯·è¾“å…¥ 1-${#SNAPSHOT_FILES[@]} ä¹‹é—´çš„æ•°å­—${NC}"
    done

    SELECTED_SNAPSHOT="${SNAPSHOT_FILES[$((CHOICE-1))]}"
    log_success "é€‰æ‹©çš„å¿«ç…§: $(basename "$SELECTED_SNAPSHOT")"
    
    # åˆ†æå¿«ç…§
    if ! analyze_snapshot "$SELECTED_SNAPSHOT"; then
        log_error "å¿«ç…§åˆ†æå¤±è´¥"
        return 1
    fi
    
    return 0
}

# ====================================================================
# è¿œç¨‹æ¢å¤åŠŸèƒ½
# ====================================================================

setup_ssh_connection() {
    log_info "è®¾ç½®SSHè¿æ¥..."
    
    # SSHå·¥å…·æ£€æŸ¥
    local ssh_tools="ssh scp"
    for tool in $ssh_tools; do
        if ! command -v "$tool" >/dev/null 2>&1; then
            log_error "ç¼ºå°‘SSHå·¥å…·: $tool"
            return 1
        fi
    done

    # ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„è¿æ¥ä¿¡æ¯
    if [ -z "$TARGET_IP" ]; then
        log_error "é…ç½®æ–‡ä»¶ä¸­ç¼ºå°‘è¿œç¨‹æœåŠ¡å™¨ä¿¡æ¯"
        return 1
    fi

    log_info "è¿œç¨‹æœåŠ¡å™¨: $TARGET_USER@$TARGET_IP:$SSH_PORT"
    log_info "è¿œç¨‹è·¯å¾„: $FULL_REMOTE_PATH"

    # SSHè¿æ¥æ–¹å¼è®¾ç½®
    SSH_KEY="/root/.ssh/id_ed25519"
    SSH_OPTS='-o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/root/.ssh/known_hosts'
    
    if [ -f "$SSH_KEY" ]; then
        SSH_CMD="ssh -i $SSH_KEY -p $SSH_PORT $SSH_OPTS $TARGET_USER@$TARGET_IP"
        SCP_CMD="scp -i $SSH_KEY -P $SSH_PORT $SSH_OPTS"
        log_info "ä½¿ç”¨SSHå¯†é’¥è®¤è¯"
    else
        log_warning "æœªæ‰¾åˆ°SSHå¯†é’¥ï¼Œä½¿ç”¨å¯†ç è®¤è¯"
        if ! command -v sshpass >/dev/null 2>&1; then
            log_info "å®‰è£…sshpass..."
            apt-get update >/dev/null 2>&1 && apt-get install -y sshpass >/dev/null 2>&1
        fi
        
        read -s -p "SSHå¯†ç : " SSH_PASS
        echo ""
        
        if [ -z "$SSH_PASS" ]; then
            log_error "å¯†ç ä¸èƒ½ä¸ºç©º"
            return 1
        fi
        
        SSH_CMD="sshpass -p '$SSH_PASS' ssh -p $SSH_PORT $TARGET_USER@$TARGET_IP"
        SCP_CMD="sshpass -p '$SSH_PASS' scp -P $SSH_PORT"
    fi

    # æµ‹è¯•è¿æ¥
    log_info "æµ‹è¯•SSHè¿æ¥..."
    if eval "$SSH_CMD 'echo \"SSHè¿æ¥æµ‹è¯•æˆåŠŸ\"'" >/dev/null 2>&1; then
        log_success "SSHè¿æ¥æµ‹è¯•æˆåŠŸ"
        return 0
    else
        log_error "SSHè¿æ¥å¤±è´¥"
        echo -e "${YELLOW}è¯·æ£€æŸ¥:${NC}"
        echo -e "  - SSHå¯†é’¥æˆ–å¯†ç æ˜¯å¦æ­£ç¡®"
        echo -e "  - SSHç«¯å£æ˜¯å¦æ­£ç¡® (å½“å‰: $SSH_PORT)"
        echo -e "  - è¿œç¨‹æœåŠ¡å™¨æ˜¯å¦å¯è¾¾"
        echo -e "  - é˜²ç«å¢™è®¾ç½®"
        return 1
    fi
}

get_remote_snapshots() {
    log_info "è·å–è¿œç¨‹å¿«ç…§åˆ—è¡¨..."
    
    # æ£€æŸ¥è¿œç¨‹ç›®å½•
    if ! eval "$SSH_CMD 'test -d \"$FULL_REMOTE_PATH/system_snapshots\"'" 2>/dev/null; then
        log_error "è¿œç¨‹å¿«ç…§ç›®å½•ä¸å­˜åœ¨: $FULL_REMOTE_PATH/system_snapshots"
        return 1
    fi
    
    # è·å–å¿«ç…§åˆ—è¡¨ï¼Œæ”¯æŒå¤šç§æ ¼å¼
    local remote_patterns="'*.tar.gz' '*.tgz' '*.tar.bz2' '*.tar.xz' '*.tar'"
    local snapshot_list=""
    
    for pattern in $remote_patterns; do
        local files=$(eval "$SSH_CMD 'find \"$FULL_REMOTE_PATH/system_snapshots\" -maxdepth 1 -name $pattern -type f 2>/dev/null'")
        if [ -n "$files" ]; then
            snapshot_list="$snapshot_list$files"$'\n'
        fi
    done
    
    if [ -z "$snapshot_list" ]; then
        log_error "è¿œç¨‹æœªæ‰¾åˆ°å¿«ç…§æ–‡ä»¶"
        return 1
    fi

    # æ’åºå¹¶å»é™¤ç©ºè¡Œ
    snapshot_list=$(echo "$snapshot_list" | grep -v '^$' | sort -r)
    IFS=$'\n' REMOTE_SNAPSHOT_FILES=($snapshot_list)
    
    log_success "å‘ç° ${#REMOTE_SNAPSHOT_FILES[@]} ä¸ªè¿œç¨‹å¿«ç…§"
    return 0
}

show_remote_snapshots() {
    echo -e "\n${YELLOW}è¿œç¨‹å¯ç”¨å¿«ç…§:${NC}"
    
    for i in "${!REMOTE_SNAPSHOT_FILES[@]}"; do
        local snapshot_name=$(basename "${REMOTE_SNAPSHOT_FILES[$i]}")
        local snapshot_info=""
        
        # è·å–æ–‡ä»¶ä¿¡æ¯
        snapshot_info=$(eval "$SSH_CMD 'ls -lh \"${REMOTE_SNAPSHOT_FILES[$i]}\" 2>/dev/null'")
        
        if [ -n "$snapshot_info" ]; then
            local snapshot_size=$(echo "$snapshot_info" | awk '{print \$5}')
            local snapshot_date=$(echo "$snapshot_info" | awk '{print $6" "$7" "\$8}')
            local format=$(detect_snapshot_format "$snapshot_name")
            
            echo -e "$((i+1))) ${GREEN}$snapshot_name${NC}"
            echo -e "    å¤§å°: $snapshot_size | æ—¥æœŸ: $snapshot_date | æ ¼å¼: $format"
        else
            echo -e "$((i+1))) ${GREEN}$snapshot_name${NC} (æ— æ³•è·å–è¯¦ç»†ä¿¡æ¯)"
        fi
    done
}

download_remote_snapshot() {
    local selected_snapshot="\$1"
    local snapshot_name=$(basename "$selected_snapshot")
    
    # åˆ›å»ºä¸´æ—¶ç›®å½•
    mkdir -p "$TEMP_DIR"
    local local_snapshot="$TEMP_DIR/$snapshot_name"
    
    # è·å–è¿œç¨‹æ–‡ä»¶å¤§å°
    local remote_size=$(eval "$SSH_CMD 'stat -c%s \"$selected_snapshot\" 2>/dev/null'")
    if [ -n "$remote_size" ]; then
        log_info "è¿œç¨‹æ–‡ä»¶å¤§å°: $(format_bytes $remote_size)"
        
        # æ£€æŸ¥æœ¬åœ°ç©ºé—´
        local available_space=$(df "$TEMP_DIR" | awk 'NR==2 {print \$4*1024}')
        if [ "$available_space" -lt "$remote_size" ]; then
            log_error "æœ¬åœ°ç©ºé—´ä¸è¶³"
            echo -e "éœ€è¦: $(format_bytes $remote_size)"
            echo -e "å¯ç”¨: $(format_bytes $available_space)"
            return 1
        fi
    fi

    log_info "æ­£åœ¨ä¸‹è½½å¿«ç…§æ–‡ä»¶..."
    log_debug "ä¸‹è½½å‘½ä»¤: $SCP_CMD $TARGET_USER@$TARGET_IP:\"$selected_snapshot\" \"$local_snapshot\""
    
    # ä¸‹è½½æ–‡ä»¶ï¼ˆæ”¯æŒè¿›åº¦æ˜¾ç¤ºï¼‰
    local start_time=$(date +%s)
    
    if command -v rsync >/dev/null 2>&1 && eval "$SSH_CMD 'command -v rsync >/dev/null 2>&1'"; then
        log_info "ä½¿ç”¨rsyncä¸‹è½½ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰..."
        if rsync -avz --partial --progress --timeout=1800 \
           -e "ssh -i $SSH_KEY -p $SSH_PORT $SSH_OPTS" \
           "$TARGET_USER@$TARGET_IP:$selected_snapshot" "$local_snapshot"; then
            download_success=1
        fi
    else
        # ä½¿ç”¨scpä¸‹è½½
        if eval "$SCP_CMD $TARGET_USER@$TARGET_IP:\"$selected_snapshot\" \"$local_snapshot\""; then
            download_success=1
        fi
    fi
    
    if [ "$download_success" != 1 ]; then
        log_error "ä¸‹è½½å¤±è´¥"
        return 1
    fi
    
    # è®¡ç®—ä¸‹è½½ç»Ÿè®¡
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local downloaded_size=$(stat -c%s "$local_snapshot" 2>/dev/null || echo 0)
    
    log_success "ä¸‹è½½å®Œæˆ"
    log_info "è€—æ—¶: ${duration}ç§’, å¤§å°: $(format_bytes $downloaded_size)"
    
    if [ "$duration" -gt 0 ] && [ "$downloaded_size" -gt 0 ]; then
        local speed=$(( downloaded_size / duration ))
        log_info "å¹³å‡é€Ÿåº¦: $(format_bytes $speed)/s"
    fi
    
    # ä¸‹è½½æ ¡éªŒå’Œæ–‡ä»¶
    local checksum_file="${selected_snapshot}.sha256"
    local local_checksum="$TEMP_DIR/$(basename "$checksum_file")"
    
    if eval "$SSH_CMD 'test -f \"$checksum_file\"'" 2>/dev/null; then
        log_info "ä¸‹è½½æ ¡éªŒå’Œæ–‡ä»¶..."
        eval "$SCP_CMD $TARGET_USER@$TARGET_IP:\"$checksum_file\" \"$local_checksum\"" >/dev/null 2>&1 || true
    fi
    
    SELECTED_SNAPSHOT="$local_snapshot"
    return 0
}

remote_restore() {
    echo -e "\n${BLUE}=== è¿œç¨‹æ¢å¤æ¨¡å¼ ===${NC}"
    
    # è®¾ç½®SSHè¿æ¥
    if ! setup_ssh_connection; then
        return 1
    fi
    
    # è·å–è¿œç¨‹å¿«ç…§åˆ—è¡¨
    if ! get_remote_snapshots; then
        return 1
    fi
    
    # æ˜¾ç¤ºè¿œç¨‹å¿«ç…§
    show_remote_snapshots
    
    echo ""
    while true; do
        read -p "é€‰æ‹©å¿«ç…§ç¼–å· [1-${#REMOTE_SNAPSHOT_FILES[@]}]: " CHOICE
        if [[ "$CHOICE" =~ ^[0-9]+$ ]] && [ "$CHOICE" -ge 1 ] && [ "$CHOICE" -le ${#REMOTE_SNAPSHOT_FILES[@]} ]; then
            break
        fi
        echo -e "${RED}é”™è¯¯: è¯·è¾“å…¥ 1-${#REMOTE_SNAPSHOT_FILES[@]} ä¹‹é—´çš„æ•°å­—${NC}"
    done

    local selected_remote="${REMOTE_SNAPSHOT_FILES[$((CHOICE-1))]}"
    log_success "é€‰æ‹©çš„å¿«ç…§: $(basename "$selected_remote")"

    # ä¸‹è½½å¿«ç…§
    send_telegram "ğŸ“¥ å¼€å§‹ä¸‹è½½å¿«ç…§\næ–‡ä»¶: $(basename "$selected_remote")\næœåŠ¡å™¨: $TARGET_USER@$TARGET_IP\næ—¶é—´: $(date '+%F %T')"
    
    if ! download_remote_snapshot "$selected_remote"; then
        send_telegram "âŒ å¿«ç…§ä¸‹è½½å¤±è´¥\næ–‡ä»¶: $(basename "$selected_remote")\næ—¶é—´: $(date '+%F %T')"
        return 1
    fi
    
    send_telegram "âœ… å¿«ç…§ä¸‹è½½æˆåŠŸ\næ–‡ä»¶: $(basename "$SELECTED_SNAPSHOT")\næ—¶é—´: $(date '+%F %T')"
    
    # åˆ†æä¸‹è½½çš„å¿«ç…§
    if ! analyze_snapshot "$SELECTED_SNAPSHOT"; then
        log_error "å¿«ç…§åˆ†æå¤±è´¥"
        return 1
    fi
    
    return 0
}

# ====================================================================
# æ‰‹åŠ¨æŒ‡å®šæ–‡ä»¶æ¢å¤
# ====================================================================

manual_file_restore() {
    echo -e "\n${BLUE}=== æŒ‡å®šæ–‡ä»¶æ¢å¤æ¨¡å¼ ===${NC}"
    
    while true; do
        read -p "è¯·è¾“å…¥å¿«ç…§æ–‡ä»¶çš„å®Œæ•´è·¯å¾„: " manual_file
        
        if [ -z "$manual_file" ]; then
            log_error "è·¯å¾„ä¸èƒ½ä¸ºç©º"
            continue
        fi
        
      if [ ! -f "$manual_file" ]; then
            log_error "æ–‡ä»¶ä¸å­˜åœ¨: $manual_file"
            continue
        fi
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯è¯»
        if [ ! -r "$manual_file" ]; then
            log_error "æ–‡ä»¶ä¸å¯è¯»: $manual_file"
            continue
        fi
        
        break
    done
    
    SELECTED_SNAPSHOT="$manual_file"
    log_success "é€‰æ‹©çš„å¿«ç…§æ–‡ä»¶: $SELECTED_SNAPSHOT"
    
    # åˆ†æå¿«ç…§
    if ! analyze_snapshot "$SELECTED_SNAPSHOT"; then
        log_error "å¿«ç…§åˆ†æå¤±è´¥"
        return 1
    fi
    
    return 0
}

# ====================================================================
# é€‰æ‹©æ€§æ¢å¤åŠŸèƒ½
# ====================================================================

selective_restore_menu() {
    echo -e "\n${CYAN}é€‰æ‹©æ€§æ¢å¤ - è¯·é€‰æ‹©è¦æ¢å¤çš„ç›®å½•:${NC}"
    echo -e "1) ${GREEN}/home${NC} - ç”¨æˆ·ç›®å½•"
    echo -e "2) ${GREEN}/etc${NC} - é…ç½®æ–‡ä»¶"
    echo -e "3) ${GREEN}/var/www${NC} - Webæ–‡ä»¶"
    echo -e "4) ${GREEN}/var/lib${NC} - åº”ç”¨æ•°æ®"
    echo -e "5) ${GREEN}/opt${NC} - ç¬¬ä¸‰æ–¹è½¯ä»¶"
    echo -e "6) ${GREEN}è‡ªå®šä¹‰è·¯å¾„${NC}"
    echo -e "7) ${YELLOW}å¤šé€‰æ¨¡å¼${NC}"
    echo ""
    
    SELECTIVE_PATHS=()
    
    while true; do
        read -p "é€‰æ‹©è¦æ¢å¤çš„ç›®å½• [1-7]: " sel_choice
        
        case "$sel_choice" in
            1) SELECTIVE_PATHS+=("home/"); break ;;
            2) SELECTIVE_PATHS+=("etc/"); break ;;
            3) SELECTIVE_PATHS+=("var/www/"); break ;;
            4) SELECTIVE_PATHS+=("var/lib/"); break ;;
            5) SELECTIVE_PATHS+=("opt/"); break ;;
            6)
                read -p "è¯·è¾“å…¥è‡ªå®šä¹‰è·¯å¾„ (ç›¸å¯¹äºæ ¹ç›®å½•ï¼Œå¦‚ usr/local/): " custom_path
                if [ -n "$custom_path" ]; then
                    # ç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®
                    custom_path=$(echo "$custom_path" | sed 's|^/||' | sed 's|/$|/|')
                    SELECTIVE_PATHS+=("$custom_path")
                fi
                break ;;
            7)
                echo -e "${CYAN}å¤šé€‰æ¨¡å¼ - è¾“å…¥æ•°å­—é€‰æ‹©ç›®å½•ï¼Œè¾“å…¥'done'ç»“æŸ:${NC}"
                while true; do
                    read -p "é€‰æ‹©ç›®å½• [1-6] æˆ– 'done': " multi_choice
                    case "$multi_choice" in
                        1) SELECTIVE_PATHS+=("home/"); echo "å·²æ·»åŠ : /home" ;;
                        2) SELECTIVE_PATHS+=("etc/"); echo "å·²æ·»åŠ : /etc" ;;
                        3) SELECTIVE_PATHS+=("var/www/"); echo "å·²æ·»åŠ : /var/www" ;;
                        4) SELECTIVE_PATHS+=("var/lib/"); echo "å·²æ·»åŠ : /var/lib" ;;
                        5) SELECTIVE_PATHS+=("opt/"); echo "å·²æ·»åŠ : /opt" ;;
                        6) 
                            read -p "è‡ªå®šä¹‰è·¯å¾„: " custom_path
                            if [ -n "$custom_path" ]; then
                                custom_path=$(echo "$custom_path" | sed 's|^/||' | sed 's|/$|/|')
                                SELECTIVE_PATHS+=("$custom_path")
                                echo "å·²æ·»åŠ : /$custom_path"
                            fi
                            ;;
                        "done") break ;;
                        *) echo -e "${RED}æ— æ•ˆé€‰æ‹©${NC}" ;;
                    esac
                done
                break ;;
            *) echo -e "${RED}é”™è¯¯: è¯·è¾“å…¥ 1-7 ä¹‹é—´çš„æ•°å­—${NC}" ;;
        esac
    done
    
    if [ ${#SELECTIVE_PATHS[@]} -eq 0 ]; then
        log_error "æœªé€‰æ‹©ä»»ä½•æ¢å¤è·¯å¾„"
        return 1
    fi
    
    echo -e "\n${GREEN}å°†æ¢å¤ä»¥ä¸‹è·¯å¾„:${NC}"
    for path in "${SELECTIVE_PATHS[@]}"; do
        echo -e "  /${path%/}"
    done
    
    return 0
}

# ====================================================================
# ç³»ç»ŸçŠ¶æ€å¤‡ä»½å’Œæ¢å¤å‡†å¤‡
# ====================================================================

backup_current_system() {
    log_info "å¤‡ä»½å½“å‰ç³»ç»Ÿå…³é”®é…ç½®..."
    
    mkdir -p "$BACKUP_CONFIG_DIR"
    
    # ç½‘ç»œé…ç½®
    [ -f /etc/fstab ] && cp /etc/fstab "$BACKUP_CONFIG_DIR/" 2>/dev/null
    [ -d /etc/network ] && cp -r /etc/network "$BACKUP_CONFIG_DIR/" 2>/dev/null
    [ -d /etc/netplan ] && cp -r /etc/netplan "$BACKUP_CONFIG_DIR/" 2>/dev/null
    [ -f /etc/hostname ] && cp /etc/hostname "$BACKUP_CONFIG_DIR/" 2>/dev/null
    [ -f /etc/hosts ] && cp /etc/hosts "$BACKUP_CONFIG_DIR/" 2>/dev/null
    [ -f /etc/resolv.conf ] && cp /etc/resolv.conf "$BACKUP_CONFIG_DIR/" 2>/dev/null
    
    # SSHé…ç½®
    [ -d /etc/ssh ] && cp -r /etc/ssh "$BACKUP_CONFIG_DIR/" 2>/dev/null
    [ -d /root/.ssh ] && cp -r /root/.ssh "$BACKUP_CONFIG_DIR/" 2>/dev/null
    
    # ç³»ç»ŸæœåŠ¡çŠ¶æ€
    systemctl list-units --type=service --state=active > "$BACKUP_CONFIG_DIR/active_services.list" 2>/dev/null
    
    # å½“å‰ç”¨æˆ·å’Œç»„
    cp /etc/passwd "$BACKUP_CONFIG_DIR/" 2>/dev/null
    cp /etc/group "$BACKUP_CONFIG_DIR/" 2>/dev/null
    cp /etc/shadow "$BACKUP_CONFIG_DIR/" 2>/dev/null
    
    # æŒ‚è½½ä¿¡æ¯
    mount > "$BACKUP_CONFIG_DIR/current_mounts.list" 2>/dev/null
    
    log_success "ç³»ç»Ÿé…ç½®å¤‡ä»½å®Œæˆ"
}

stop_services() {
    log_info "åœæ­¢ç›¸å…³ç³»ç»ŸæœåŠ¡..."
    
    # éœ€è¦åœæ­¢çš„æœåŠ¡åˆ—è¡¨
    local services_to_stop="apache2 nginx mysql postgresql docker redis-server mongodb"
    
    for service in $services_to_stop; do
        if systemctl is-active --quiet "$service" 2>/dev/null; then
            log_info "åœæ­¢æœåŠ¡: $service"
            systemctl stop "$service" 2>/dev/null || true
            sleep 2
        fi
    done
    
    # åŒæ­¥æ–‡ä»¶ç³»ç»Ÿ
    log_info "åŒæ­¥æ–‡ä»¶ç³»ç»Ÿ..."
    sync
    
    log_success "æœåŠ¡åœæ­¢å®Œæˆ"
}

# ====================================================================
# æ ¸å¿ƒæ¢å¤åŠŸèƒ½
# ====================================================================

build_tar_exclude_options() {
    local mode="\$1"
    local exclude_opts=""
    
    # åŸºç¡€æ’é™¤é¡¹ï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½æ’é™¤ï¼‰
    local base_excludes="dev/* proc/* sys/* run/* tmp/* var/tmp/* lost+found"
    local backup_excludes="$BACKUP_DIR/* /tmp/snapsync_* /tmp/current_config_backup_*"
    
    for item in $base_excludes $backup_excludes; do
        exclude_opts="$exclude_opts --exclude=$item"
    done
    
    # æ ‡å‡†æ¨¡å¼æ’é™¤é¡¹ï¼ˆä¿ç•™ç½‘ç»œé…ç½®ç­‰ï¼‰
    if [ "$mode" = "standard" ]; then
        local preserve_configs="etc/fstab etc/hostname etc/hosts etc/network/* etc/netplan/*"
        preserve_configs="$preserve_configs etc/resolv.conf etc/ssh/* root/.ssh/*"
        
        for item in $preserve_configs; do
            exclude_opts="$exclude_opts --exclude=$item"
        done
    fi
    
    echo "$exclude_opts"
}

build_tar_include_options() {
    if [ ${#SELECTIVE_PATHS[@]} -gt 0 ]; then
        local include_opts=""
        for path in "${SELECTIVE_PATHS[@]}"; do
            include_opts="$include_opts $path*"
        done
        echo "$include_opts"
    fi
}

show_restore_progress() {
    local pid="\$1"
    local snapshot_file="\$2"
    
    # è·å–å¿«ç…§æ–‡ä»¶å¤§å°
    local total_size=$(stat -c%s "$snapshot_file" 2>/dev/null || echo 0)
    
    echo -e "${CYAN}æ¢å¤è¿›åº¦ç›‘æ§:${NC}"
    
    while kill -0 "$pid" 2>/dev/null; do
        # æ˜¾ç¤ºç³»ç»Ÿè´Ÿè½½
        local load_avg=$(cat /proc/loadavg | awk '{print $1}')
        local mem_usage=$(free | awk 'NR==2{printf "%.1f%%", $3*100/\$2 }')
        
        printf "\r${YELLOW}è´Ÿè½½: %s | å†…å­˜: %s | çŠ¶æ€: æ¢å¤ä¸­...${NC}" "$load_avg" "$mem_usage"
        sleep 2
    done
    
    echo ""
}

perform_restore_operation() {
    local mode="\$1"
    local snapshot_file="$SELECTED_SNAPSHOT"
    
    log_info "å¼€å§‹æ‰§è¡Œæ¢å¤æ“ä½œ..."
    log_debug "æ¢å¤æ¨¡å¼: $mode"
    log_debug "å¿«ç…§æ–‡ä»¶: $snapshot_file"
    log_debug "å‹ç¼©æ ¼å¼: $SNAPSHOT_FORMAT"
    
    # æ„å»ºtaré€‰é¡¹
    local exclude_opts=$(build_tar_exclude_options "$mode")
    local include_opts=$(build_tar_include_options)
    local tar_opts="--same-owner --same-permissions --numeric-owner"
    
    # å¢å¼ºç‰¹æ€§æ”¯æŒ
    if [ "$SNAPSHOT_HAS_ACL" = "æ˜¯" ] && command -v setfacl >/dev/null 2>&1; then
        tar_opts="$tar_opts --acls"
        log_info "å¯ç”¨ACLæ¢å¤"
    fi
    
    if [ "$SNAPSHOT_HAS_XATTR" = "æ˜¯" ] && command -v setfattr >/dev/null 2>&1; then
        tar_opts="$tar_opts --xattrs"
        log_info "å¯ç”¨æ‰©å±•å±æ€§æ¢å¤"
    fi
    
    # æ„å»ºå®Œæ•´å‘½ä»¤
    local decomp_cmd="$SNAPSHOT_DECOMP_CMD"
    local tar_cmd="tar -x $tar_opts -f -"
    
    if [ -n "$include_opts" ]; then
        # é€‰æ‹©æ€§æ¢å¤
        tar_cmd="$tar_cmd $include_opts"
        log_info "æ‰§è¡Œé€‰æ‹©æ€§æ¢å¤: ${SELECTIVE_PATHS[*]}"
    else
        # å…¨é‡æ¢å¤
        tar_cmd="$tar_cmd $exclude_opts"
    fi
    
    # æœ€ç»ˆæ‰§è¡Œå‘½ä»¤
    local full_cmd="$decomp_cmd '$snapshot_file' | $tar_cmd -C /"
    log_debug "æ‰§è¡Œå‘½ä»¤: $full_cmd"
    
    # è®°å½•å¼€å§‹æ—¶é—´
    local start_time=$(date +%s)
    
    # æ‰§è¡Œæ¢å¤ï¼ˆåå°è¿è¡Œä»¥ä¾¿æ˜¾ç¤ºè¿›åº¦ï¼‰
    eval "$full_cmd" &
    local restore_pid=$!
    
    # æ˜¾ç¤ºè¿›åº¦
    show_restore_progress $restore_pid "$snapshot_file"
    
    # ç­‰å¾…å®Œæˆ
    wait $restore_pid
    local exit_code=$?
    
    # è®¡ç®—è€—æ—¶
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    if [ $exit_code -eq 0 ]; then
        log_success "æ¢å¤æ“ä½œå®Œæˆ (è€—æ—¶: ${duration}ç§’)"
        return 0
    else
        log_error "æ¢å¤æ“ä½œå¤±è´¥ (é€€å‡ºç : $exit_code)"
        return 1
    fi
}

restore_preserved_configs() {
    local mode="\$1"
    
    if [ "$mode" != "standard" ] || [ ! -d "$BACKUP_CONFIG_DIR" ]; then
        return 0
    fi
    
    log_info "æ¢å¤ä¿ç•™çš„ç³»ç»Ÿé…ç½®..."
    
    # æ¢å¤ç½‘ç»œé…ç½®
    [ -f "$BACKUP_CONFIG_DIR/fstab" ] && cp "$BACKUP_CONFIG_DIR/fstab" /etc/ 2>/dev/null
    [ -d "$BACKUP_CONFIG_DIR/network" ] && cp -r "$BACKUP_CONFIG_DIR/network" /etc/ 2>/dev/null
    [ -d "$BACKUP_CONFIG_DIR/netplan" ] && cp -r "$BACKUP_CONFIG_DIR/netplan" /etc/ 2>/dev/null
    [ -f "$BACKUP_CONFIG_DIR/hostname" ] && cp "$BACKUP_CONFIG_DIR/hostname" /etc/ 2>/dev/null
    [ -f "$BACKUP_CONFIG_DIR/hosts" ] && cp "$BACKUP_CONFIG_DIR/hosts" /etc/ 2>/dev/null
    [ -f "$BACKUP_CONFIG_DIR/resolv.conf" ] && cp "$BACKUP_CONFIG_DIR/resolv.conf" /etc/ 2>/dev/null
    
    # æ¢å¤SSHé…ç½®
    if [ -d "$BACKUP_CONFIG_DIR/ssh" ]; then
        cp -r "$BACKUP_CONFIG_DIR/ssh" /etc/ 2>/dev/null
        chmod 644 /etc/ssh/*.pub 2>/dev/null
        chmod 600 /etc/ssh/*_key 2>/dev/null
    fi
    
    if [ -d "$BACKUP_CONFIG_DIR/.ssh" ]; then
        cp -r "$BACKUP_CONFIG_DIR/.ssh" /root/ 2>/dev/null
        chmod 700 /root/.ssh 2>/dev/null
        chmod 600 /root/.ssh/* 2>/dev/null
        chmod 644 /root/.ssh/*.pub 2>/dev/null
    fi
    
    log_success "ä¿ç•™é…ç½®æ¢å¤å®Œæˆ"
}

post_restore_tasks() {
    log_info "æ‰§è¡Œæ¢å¤åä»»åŠ¡..."
    
    # æ›´æ–°å¼•å¯¼ç¨‹åº
    if command -v update-grub >/dev/null 2>&1; then
        log_info "æ›´æ–°GRUBé…ç½®..."
        update-grub >/dev/null 2>&1 || log_warning "GRUBæ›´æ–°å¤±è´¥"
    fi
    
    # é‡æ–°ç”ŸæˆSSHä¸»æœºå¯†é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if [ ! -f /etc/ssh/ssh_host_ed25519_key ]; then
        log_info "é‡æ–°ç”ŸæˆSSHä¸»æœºå¯†é’¥..."
        ssh-keygen -A >/dev/null 2>&1 || log_warning "SSHå¯†é’¥ç”Ÿæˆå¤±è´¥"
    fi
    
    # æ›´æ–°ç³»ç»Ÿä¿¡æ¯
    if command -v update-motd >/dev/null 2>&1; then
        update-motd >/dev/null 2>&1 || true
    fi
    
    # åŒæ­¥æ–‡ä»¶ç³»ç»Ÿ
    sync
    
    log_success "æ¢å¤åä»»åŠ¡å®Œæˆ"
}

# ä¸»æ¢å¤æµç¨‹
# ====================================================================

execute_restore() {
    local restore_mode_name=""
    case "$RESTORE_MODE" in
        1) restore_mode_name="æ ‡å‡†æ¢å¤" ;;
        2) restore_mode_name="å®Œå…¨æ¢å¤" ;;
        3) restore_mode_name="é€‰æ‹©æ€§æ¢å¤" ;;
    esac
    
    echo -e "\n${PURPLE}=== å¼€å§‹æ‰§è¡Œæ¢å¤æ“ä½œ ===${NC}"
    echo -e "${CYAN}æ¢å¤æ¨¡å¼: $restore_mode_name${NC}"
    echo -e "${CYAN}å¿«ç…§æ–‡ä»¶: $(basename "$SELECTED_SNAPSHOT")${NC}"
    echo -e "${CYAN}æ—¶é—´æˆ³: $(date '+%Y-%m-%d %H:%M:%S')${NC}"
    
    # å‘é€å¼€å§‹é€šçŸ¥
    local notification_msg="ğŸ”§ ç³»ç»Ÿæ¢å¤å¼€å§‹\n"
    notification_msg+="æ¨¡å¼: $restore_mode_name\n"
    notification_msg+="å¿«ç…§: $(basename "$SELECTED_SNAPSHOT")\n"
    notification_msg+="æ ¼å¼: $SNAPSHOT_FORMAT\n"
    notification_msg+="æ—¶é—´: $(date '+%F %T')"
    send_telegram "$notification_msg"
    
    # æœ€åç¡®è®¤
    echo -e "\n${YELLOW}âš ï¸  è­¦å‘Š: æ¢å¤æ“ä½œå°†è¦†ç›–ç°æœ‰ç³»ç»Ÿæ–‡ä»¶!${NC}"
    read -p "ç¡®è®¤æ‰§è¡Œæ¢å¤? [yes/NO]: " final_confirm
    
    if [ "$final_confirm" != "yes" ]; then
        log_warning "ç”¨æˆ·å–æ¶ˆæ¢å¤æ“ä½œ"
        return 1
    fi
    
    # é€‰æ‹©æ€§æ¢å¤çš„é¢å¤–è®¾ç½®
    if [ "$RESTORE_MODE" -eq 3 ]; then
        if ! selective_restore_menu; then
            return 1
        fi
    fi
    
    # å¤‡ä»½å½“å‰ç³»ç»Ÿé…ç½®
    backup_current_system
    
    # åœæ­¢ç›¸å…³æœåŠ¡
    stop_services
    
    # æ‰§è¡Œå…·ä½“æ¢å¤æ“ä½œ
    local mode_flag=""
    case "$RESTORE_MODE" in
        1) mode_flag="standard" ;;
        2) mode_flag="complete" ;;
        3) mode_flag="selective" ;;
    esac
    
    if ! perform_restore_operation "$mode_flag"; then
        log_error "æ¢å¤æ“ä½œå¤±è´¥"
        send_telegram "âŒ ç³»ç»Ÿæ¢å¤å¤±è´¥\næ—¶é—´: $(date '+%F %T')\nè¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶"
        return 1
    fi
    
    # æ ‡å‡†æ¨¡å¼éœ€è¦æ¢å¤ä¿ç•™çš„é…ç½®
    restore_preserved_configs "$mode_flag"
    
    # æ‰§è¡Œæ¢å¤åä»»åŠ¡
    post_restore_tasks
    
    log_success "ç³»ç»Ÿæ¢å¤å®Œæˆ"
    
    # å‘é€æˆåŠŸé€šçŸ¥
    local success_msg="âœ… ç³»ç»Ÿæ¢å¤æˆåŠŸ\n"
    success_msg+="æ¨¡å¼: $restore_mode_name\n"
    success_msg+="å¿«ç…§: $(basename "$SELECTED_SNAPSHOT")\n"
    success_msg+="æ—¶é—´: $(date '+%F %T')\n"
    success_msg+="å»ºè®®é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆ"
    send_telegram "$success_msg"
    
    return 0
}

# ====================================================================
# é‡å¯ç¡®è®¤åŠŸèƒ½
# ====================================================================

show_reboot_options() {
    echo -e "\n${GREEN}æ¢å¤æ“ä½œå·²æˆåŠŸå®Œæˆ!${NC}"
    echo -e "${YELLOW}å»ºè®®é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆ${NC}"
    echo ""
    echo -e "é‡å¯é€‰é¡¹:"
    echo -e "1) ${GREEN}ç«‹å³é‡å¯${NC}"
    echo -e "2) ${GREEN}å»¶è¿Ÿé‡å¯${NC} (æŒ‡å®šåˆ†é’Ÿå)"
    echo -e "3) ${YELLOW}ç¨åæ‰‹åŠ¨é‡å¯${NC}"
    echo ""
    
    while true; do
        read -p "é€‰æ‹©é‡å¯æ–¹å¼ [1-3]: " reboot_choice
        
        case "$reboot_choice" in
            1)
                echo -e "${CYAN}ç³»ç»Ÿå°†åœ¨10ç§’åé‡å¯...${NC}"
                for i in {10..1}; do
                    echo -ne "\r${YELLOW}é‡å¯å€’è®¡æ—¶: ${i}ç§’ (Ctrl+Cå–æ¶ˆ)${NC}"
                    sleep 1
                done
                echo ""
                log_info "æ‰§è¡Œç«‹å³é‡å¯"
                send_telegram "ğŸ”„ ç³»ç»Ÿæ¢å¤å®Œæˆï¼Œæ­£åœ¨é‡å¯...\næ—¶é—´: $(date '+%F %T')"
                reboot
                ;;
            2)
                while true; do
                    read -p "è¯·è¾“å…¥å»¶è¿Ÿåˆ†é’Ÿæ•° [1-60]: " delay_minutes
                    if [[ "$delay_minutes" =~ ^[1-9][0-9]?$ ]] && [ "$delay_minutes" -le 60 ]; then
                        echo -e "${CYAN}ç³»ç»Ÿå°†åœ¨ $delay_minutes åˆ†é’Ÿåé‡å¯${NC}"
                        log_info "è®¾ç½®å»¶è¿Ÿé‡å¯: $delay_minutes åˆ†é’Ÿ"
                        send_telegram "â° ç³»ç»Ÿæ¢å¤å®Œæˆï¼Œå°†åœ¨${delay_minutes}åˆ†é’Ÿåé‡å¯\næ—¶é—´: $(date '+%F %T')"
                        shutdown -r +$delay_minutes "ç³»ç»Ÿæ¢å¤å®Œæˆï¼Œè‡ªåŠ¨é‡å¯"
                        echo -e "${GREEN}å»¶è¿Ÿé‡å¯å·²è®¾ç½®${NC}"
                        break
                    else
                        echo -e "${RED}è¯·è¾“å…¥ 1-60 ä¹‹é—´çš„æ•°å­—${NC}"
                    fi
                done
                break
                ;;
            3)
                echo -e "${CYAN}è¯·è®°å¾—ç¨åæ‰‹åŠ¨é‡å¯ç³»ç»Ÿ${NC}"
                log_info "ç”¨æˆ·é€‰æ‹©ç¨åæ‰‹åŠ¨é‡å¯"
                break
                ;;
            *)
                echo -e "${RED}è¯·è¾“å…¥ 1-3 ä¹‹é—´çš„æ•°å­—${NC}"
                ;;
        esac
        
        if [ "$reboot_choice" != "1" ]; then
            break
        fi
    done
}

# ====================================================================
# é”™è¯¯å¤„ç†å’Œæ¢å¤
# ====================================================================

handle_restore_failure() {
    log_error "æ¢å¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"
    
    echo -e "\n${RED}æ¢å¤å¤±è´¥å¤„ç†é€‰é¡¹:${NC}"
    echo -e "1) ${YELLOW}æŸ¥çœ‹é”™è¯¯æ—¥å¿—${NC}"
    echo -e "2) ${YELLOW}å°è¯•ä½¿ç”¨å…¶ä»–å¿«ç…§${NC}"
    echo -e "3) ${YELLOW}æ¢å¤å¤‡ä»½çš„é…ç½®${NC}"
    echo -e "4) ${RED}é€€å‡ºç¨‹åº${NC}"
    
    while true; do
        read -p "é€‰æ‹©å¤„ç†æ–¹å¼ [1-4]: " error_choice
        
        case "$error_choice" in
            1)
                echo -e "\n${CYAN}=== æœ€è¿‘çš„é”™è¯¯æ—¥å¿— ===${NC}"
                if [ -f "$RESTORE_LOG_FILE" ]; then
                    tail -20 "$RESTORE_LOG_FILE"
                fi
                if [ -f "$DEBUG_LOG_FILE" ]; then
                    echo -e "\n${CYAN}=== è°ƒè¯•æ—¥å¿— ===${NC}"
                    tail -10 "$DEBUG_LOG_FILE"
                fi
                read -p "æŒ‰å›è½¦ç»§ç»­..."
                ;;
            2)
                return 1  # è¿”å›é‡æ–°é€‰æ‹©å¿«ç…§
                ;;
            3)
                if [ -d "$BACKUP_CONFIG_DIR" ]; then
                    log_info "æ¢å¤å¤‡ä»½çš„é…ç½®æ–‡ä»¶..."
                    restore_preserved_configs "standard"
                    echo -e "${GREEN}é…ç½®æ–‡ä»¶å·²æ¢å¤${NC}"
                else
                    echo -e "${YELLOW}æœªæ‰¾åˆ°å¤‡ä»½çš„é…ç½®æ–‡ä»¶${NC}"
                fi
                read -p "æŒ‰å›è½¦ç»§ç»­..."
                ;;
            4)
                log_info "ç”¨æˆ·é€‰æ‹©é€€å‡ºç¨‹åº"
                return 0
                ;;
            *)
                echo -e "${RED}è¯·è¾“å…¥ 1-4 ä¹‹é—´çš„æ•°å­—${NC}"
                ;;
        esac
    done
}

# ====================================================================
# ç³»ç»Ÿä¿¡æ¯æ£€æŸ¥
# ====================================================================

check_system_status() {
    echo -e "\n${CYAN}=== ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ ===${NC}"
    
    # ç£ç›˜ç©ºé—´æ£€æŸ¥
    local root_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "$root_usage" -gt 90 ]; then
        log_warning "æ ¹åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜: ${root_usage}%"
    else
        log_info "æ ¹åˆ†åŒºä½¿ç”¨ç‡: ${root_usage}%"
    fi
    
    # å†…å­˜æ£€æŸ¥
    local mem_info=$(free -m | awk 'NR==2{printf "ä½¿ç”¨: %sMB/%sMB (%.2f%%)", $3,$2,$3*100/\$2}')
    log_info "å†…å­˜çŠ¶æ€: $mem_info"
    
    # è´Ÿè½½æ£€æŸ¥
    local load_avg=$(uptime | awk -F'load average:' '{print $2}')
    log_info "ç³»ç»Ÿè´Ÿè½½: $load_avg"
    
    # CPUæ ¸å¿ƒæ•°
    local cpu_cores=$(nproc)
    log_info "CPUæ ¸å¿ƒæ•°: $cpu_cores"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œæ¢å¤
    local available_space=$(df /tmp | awk 'NR==2 {print $4*1024}')  # è½¬æ¢ä¸ºå­—èŠ‚
    log_info "ä¸´æ—¶ç›®å½•å¯ç”¨ç©ºé—´: $(format_bytes $available_space)"
    
    return 0
}

# ====================================================================
# å¸®åŠ©ä¿¡æ¯
# ====================================================================

show_help() {
    cat << 'EOF'
SnapSync v2.5 å¢å¼ºç‰ˆç³»ç»Ÿæ¢å¤å·¥å…·

ç”¨æ³•: ./remote_restore [é€‰é¡¹]

é€‰é¡¹:
  -h, --help     æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  -v, --version  æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
  --check        ä»…æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
  --config       æ˜¾ç¤ºå½“å‰é…ç½®

æ¢å¤æ¨¡å¼:
  æ ‡å‡†æ¢å¤    - ä¿ç•™ç½‘ç»œé…ç½®ã€SSHå¯†é’¥ç­‰å…³é”®é…ç½®
  å®Œå…¨æ¢å¤    - æ¢å¤æ‰€æœ‰æ–‡ä»¶ï¼ˆå¯èƒ½å¯¼è‡´ç½‘ç»œé…ç½®ä¸¢å¤±ï¼‰
  é€‰æ‹©æ€§æ¢å¤  - ä»…æ¢å¤æŒ‡å®šç›®å½•

æ”¯æŒç‰¹æ€§:
  - å¤šç§å‹ç¼©æ ¼å¼ (.tar.gz, .tar.bz2, .tar.xz, .tar)
  - ACLæƒé™æ¢å¤
  - æ‰©å±•å±æ€§æ¢å¤
  - å®Œæ•´æ€§éªŒè¯
  - è¿›åº¦æ˜¾ç¤º
  - Telegramé€šçŸ¥
  - æ™ºèƒ½é…ç½®ä¿ç•™

æ—¥å¿—æ–‡ä»¶:
  /var/log/system_snapshot/restore.log       - æ¢å¤æ—¥å¿—
  /var/log/system_snapshot/restore_debug.log - è°ƒè¯•æ—¥å¿—

ç¤ºä¾‹:
  ./remote_restore              # äº¤äº’å¼æ¢å¤
  ./remote_restore --check      # æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
  ./remote_restore --config     # æŸ¥çœ‹é…ç½®

æ³¨æ„äº‹é¡¹:
  - æ¢å¤æ“ä½œä¼šè¦†ç›–ç³»ç»Ÿæ–‡ä»¶ï¼Œè¯·è°¨æ…æ“ä½œ
  - å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯æ¢å¤æµç¨‹
  - æ ‡å‡†æ¨¡å¼æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ
  - æ¢å¤åå»ºè®®é‡å¯ç³»ç»Ÿ

EOF
}

show_version() {
    echo "SnapSync æ¢å¤å·¥å…· v$SCRIPT_VERSION"
    echo "å…¼å®¹å¤‡ä»½ç‰ˆæœ¬: v2.5+"
    echo "ä½œè€…: SnapSync Development Team"
    echo "è®¸å¯è¯: MIT"
}

show_current_config() {
    if [ -f "$CONFIG_FILE" ]; then
        echo -e "${CYAN}=== å½“å‰é…ç½®ä¿¡æ¯ ===${NC}"
        echo "é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        echo ""
        
        # å®‰å…¨æ˜¾ç¤ºé…ç½®ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
        while IFS='=' read -r key value; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            [[ "$key" =~ ^[[:space:]]*# ]] && continue
            [[ -z "$key" ]] && continue
            
            # éšè—æ•æ„Ÿä¿¡æ¯
            if [[ "$key" =~ (PASSWORD|TOKEN|PASS) ]]; then
                echo "$key=****"
            else
                echo "$key=$value"
            fi
        done < "$CONFIG_FILE"
    else
        echo -e "${YELLOW}é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE${NC}"
    fi
}

# ====================================================================
# å‘½ä»¤è¡Œå‚æ•°å¤„ç†
# ====================================================================

parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case \$1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            --check)
                check_system_status
                exit 0
                ;;
            --config)
                show_current_config
                exit 0
                ;;
            *)
                echo -e "${RED}æœªçŸ¥å‚æ•°: $1${NC}"
                echo "ä½¿ç”¨ --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
                exit 1
                ;;
        esac
        shift
    done
}

# ====================================================================
# ä¸»ç¨‹åºæµç¨‹
# ====================================================================

main() {
    # å¤„ç†å‘½ä»¤è¡Œå‚æ•°
    parse_arguments "$@"
    
    # æ˜¾ç¤ºæ ‡é¢˜
    show_title
    
    # æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
    if ! check_requirements; then
        log_error "ç³»ç»Ÿè¦æ±‚æ£€æŸ¥å¤±è´¥"
        exit 1
    fi
    
    # æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
    check_system_status
    
    # åŠ è½½é…ç½®
    load_config
    
    # ä¸»å¾ªç¯ - å…è®¸é‡è¯•
    while true; do
        # é€‰æ‹©æ¢å¤æ–¹å¼
        show_restore_types
        
        # æ ¹æ®é€‰æ‹©æ‰§è¡Œç›¸åº”çš„æ¢å¤å‡†å¤‡
        case "$RESTORE_TYPE" in
            1)
                if ! local_restore; then
                    if ! handle_restore_failure; then
                        continue  # é‡æ–°é€‰æ‹©
                    else
                        break  # é€€å‡º
                    fi
                fi
                ;;
            2)
                if ! remote_restore; then
                    if ! handle_restore_failure; then
                        continue  # é‡æ–°é€‰æ‹©
                    else
                        break  # é€€å‡º
                    fi
                fi
                ;;
            3)
                if ! manual_file_restore; then
                    if ! handle_restore_failure; then
                        continue  # é‡æ–°é€‰æ‹©
                    else
                        break  # é€€å‡º
                    fi
                fi
                ;;
        esac
        
        # é€‰æ‹©æ¢å¤æ¨¡å¼
        show_restore_modes
        
        # æ‰§è¡Œæ¢å¤
        if execute_restore; then
            # æ˜¾ç¤ºé‡å¯é€‰é¡¹
            show_reboot_options
            break
        else
            # å¤„ç†æ¢å¤å¤±è´¥
            if ! handle_restore_failure; then
                continue  # é‡æ–°å¼€å§‹
            else
                break  # é€€å‡º
                   fi
    done
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    cleanup_temp_files
    
    log_info "æ¢å¤ç¨‹åºç»“æŸ"
}

# ====================================================================
# ä¸´æ—¶æ–‡ä»¶æ¸…ç†
# ====================================================================

cleanup_temp_files() {
    log_info "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    
    # æ¸…ç†ä¸‹è½½çš„å¿«ç…§æ–‡ä»¶
    if [ -n "$SELECTED_SNAPSHOT" ] && [[ "$SELECTED_SNAPSHOT" == "$TEMP_DIR"* ]]; then
        if [ -f "$SELECTED_SNAPSHOT" ]; then
            log_debug "åˆ é™¤ä¸´æ—¶å¿«ç…§: $SELECTED_SNAPSHOT"
            rm -f "$SELECTED_SNAPSHOT"
        fi
        
        # æ¸…ç†ç›¸å…³æ ¡éªŒæ–‡ä»¶
        rm -f "${SELECTED_SNAPSHOT}.sha256" 2>/dev/null
    fi
    
    # æ¸…ç†ä¸´æ—¶ç›®å½•ï¼ˆä¿ç•™å¤‡ä»½é…ç½®ï¼‰
    if [ -d "$TEMP_DIR" ]; then
        find "$TEMP_DIR" -type f -name "system_snapshot_*" -delete 2>/dev/null
        find "$TEMP_DIR" -type f -name "*.sha256" -delete 2>/dev/null
    fi
    
    log_debug "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
}

# ====================================================================
# ä¿¡å·å¤„ç†
# ====================================================================

handle_interrupt() {
    echo -e "\n\n${YELLOW}æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨å®‰å…¨é€€å‡º...${NC}"
    
    log_warning "ç¨‹åºè¢«ç”¨æˆ·ä¸­æ–­"
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    cleanup_temp_files
    
    # å¦‚æœæœ‰åå°è¿›ç¨‹ï¼Œå°è¯•ç»ˆæ­¢
    if [ -n "$restore_pid" ]; then
        log_info "ç»ˆæ­¢æ¢å¤è¿›ç¨‹..."
        kill -TERM "$restore_pid" 2>/dev/null || true
        sleep 2
        kill -KILL "$restore_pid" 2>/dev/null || true
    fi
    
    # å‘é€ä¸­æ–­é€šçŸ¥
    send_telegram "âš ï¸ ç³»ç»Ÿæ¢å¤è¢«ç”¨æˆ·ä¸­æ–­\næ—¶é—´: $(date '+%F %T')"
    
    echo -e "${RED}ç¨‹åºå·²ä¸­æ–­é€€å‡º${NC}"
    exit 130
}

# è®¾ç½®ä¿¡å·å¤„ç†
trap handle_interrupt INT TERM

# ====================================================================
# è„šæœ¬éªŒè¯å’Œå®Œæ•´æ€§æ£€æŸ¥
# ====================================================================

verify_script_integrity() {
    # æ£€æŸ¥è„šæœ¬æ–‡ä»¶å®Œæ•´æ€§
    if [ ! -r "$0" ]; then
        log_error "æ— æ³•è¯»å–è„šæœ¬æ–‡ä»¶"
        return 1
    fi
    
    # æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦å®šä¹‰
    local critical_functions="load_config show_restore_types execute_restore"
    for func in $critical_functions; do
        if ! type "$func" >/dev/null 2>&1; then
            log_error "å…³é”®å‡½æ•°æœªå®šä¹‰: $func"
            return 1
        fi
    done
    
    return 0
}

# ====================================================================
# å¯åŠ¨æ£€æŸ¥å’Œåˆå§‹åŒ–
# ====================================================================

initialize_script() {
    # éªŒè¯è„šæœ¬å®Œæ•´æ€§
    if ! verify_script_integrity; then
        echo -e "${RED}è„šæœ¬å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥${NC}"
        exit 1
    fi
    
    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    mkdir -p "$TEMP_DIR"
    mkdir -p "$(dirname "$RESTORE_LOG_FILE")"
    mkdir -p "$(dirname "$DEBUG_LOG_FILE")"
    
    # åˆå§‹åŒ–æ—¥å¿—
    log_info "====== SnapSync æ¢å¤å·¥å…·å¯åŠ¨ v$SCRIPT_VERSION ======"
    log_info "å¯åŠ¨æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    log_info "ç”¨æˆ·: $(whoami)"
    log_info "PID: $$"
    
    # è®°å½•ç³»ç»Ÿä¿¡æ¯
    log_debug "ç³»ç»Ÿä¿¡æ¯: $(uname -a)"
    log_debug "è„šæœ¬è·¯å¾„: $0"
    log_debug "å·¥ä½œç›®å½•: $(pwd)"
    
    return 0
}

# ====================================================================
# é”™è¯¯é€€å‡ºå¤„ç†
# ====================================================================

exit_with_error() {
    local error_msg="$1"
    local exit_code="${2:-1}"
    
    log_error "$error_msg"
    send_telegram "âŒ æ¢å¤å·¥å…·é”™è¯¯\né”™è¯¯: $error_msg\næ—¶é—´: $(date '+%F %T')"
    
    cleanup_temp_files
    exit "$exit_code"
}

# ====================================================================
# è¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥
# ====================================================================

runtime_safety_check() {
    # æ£€æŸ¥æ˜¯å¦åœ¨å®¹å™¨ä¸­è¿è¡Œ
    if [ -f /.dockerenv ]; then
        log_warning "æ£€æµ‹åˆ°åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œ"
        echo -e "${YELLOW}è­¦å‘Š: åœ¨å®¹å™¨ä¸­æ¢å¤ç³»ç»Ÿå¯èƒ½å¯¼è‡´ä¸å¯é¢„æœŸçš„ç»“æœ${NC}"
        read -p "æ˜¯å¦ç»§ç»­? [y/N]: " container_confirm
        if [ "$container_confirm" != "y" ] && [ "$container_confirm" != "Y" ]; then
            exit_with_error "ç”¨æˆ·å–æ¶ˆå®¹å™¨ä¸­çš„æ¢å¤æ“ä½œ" 0
        fi
    fi
    
    # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿç±»å‹
    local rootfs_type=$(df -T / | awk 'NR==2 {print $2}')
    if [ "$rootfs_type" = "tmpfs" ] || [ "$rootfs_type" = "ramfs" ]; then
        log_warning "æ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹: $rootfs_type"
        echo -e "${YELLOW}è­¦å‘Š: å½“å‰æ ¹æ–‡ä»¶ç³»ç»Ÿä¸ºå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œæ¢å¤åæ•°æ®å°†åœ¨é‡å¯åä¸¢å¤±${NC}"
        read -p "æ˜¯å¦ç»§ç»­? [y/N]: " tmpfs_confirm
        if [ "$tmpfs_confirm" != "y" ] && [ "$tmpfs_confirm" != "Y" ]; then
            exit_with_error "ç”¨æˆ·å–æ¶ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿçš„æ¢å¤æ“ä½œ" 0
        fi
    fi
    
    # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿæƒé™
    if [ ! -w /etc ] || [ ! -w /var ] || [ ! -w /usr ]; then
        exit_with_error "æƒé™ä¸è¶³ï¼Œæ— æ³•å†™å…¥ç³»ç»Ÿç›®å½•"
    fi
    
    return 0
}

# ====================================================================
# é¢„æ¢å¤ç³»ç»Ÿæ£€æŸ¥
# ====================================================================

pre_restore_system_check() {
    echo -e "\n${CYAN}=== æ¢å¤å‰ç³»ç»Ÿæ£€æŸ¥ ===${NC}"
    
    local warnings=0
    local errors=0
    
    # ç£ç›˜ç©ºé—´æ£€æŸ¥
    local root_avail=$(df / | awk 'NR==2 {print $4*1024}')  # è½¬æ¢ä¸ºå­—èŠ‚
    if [ "$root_avail" -lt 1073741824 ]; then  # 1GB
        log_warning "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´ä¸è¶³1GB: $(format_bytes $root_avail)"
        warnings=$((warnings + 1))
    fi
    
    # æ£€æŸ¥é‡è¦æœåŠ¡çŠ¶æ€
    local critical_services="systemd sshd"
    for service in $critical_services; do
        if ! systemctl is-active --quiet "$service" 2>/dev/null; then
            log_warning "å…³é”®æœåŠ¡æœªè¿è¡Œ: $service"
            warnings=$((warnings + 1))
        fi
    done
    
    # æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆç”¨äºTelegramé€šçŸ¥ï¼‰
    if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
        if ! curl -s --connect-timeout 5 "https://api.telegram.org" >/dev/null; then
            log_warning "æ— æ³•è¿æ¥åˆ°Telegram APIï¼Œé€šçŸ¥åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨"
            warnings=$((warnings + 1))
        fi
    fi
    
    # æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
    local load1=$(cat /proc/loadavg | awk '{print $1}')
    local cpu_cores=$(nproc)
    if (( $(echo "$load1 > $cpu_cores * 2" | bc -l) )); then
        log_warning "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜: $load1 (CPUæ ¸å¿ƒæ•°: $cpu_cores)"
        warnings=$((warnings + 1))
    fi
    
    # æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
    if [ "$errors" -gt 0 ]; then
        echo -e "${RED}å‘ç° $errors ä¸ªé”™è¯¯ï¼Œå»ºè®®ä¿®å¤åå†ç»§ç»­${NC}"
        return 1
    elif [ "$warnings" -gt 0 ]; then
        echo -e "${YELLOW}å‘ç° $warnings ä¸ªè­¦å‘Š${NC}"
        read -p "æ˜¯å¦å¿½ç•¥è­¦å‘Šç»§ç»­æ¢å¤? [y/N]: " ignore_warnings
        if [ "$ignore_warnings" != "y" ] && [ "$ignore_warnings" != "Y" ]; then
            return 1
        fi
    else
        log_success "ç³»ç»Ÿæ£€æŸ¥é€šè¿‡"
    fi
    
    return 0
}

# ====================================================================
# é…ç½®æ–‡ä»¶æ¨¡æ¿ç”Ÿæˆ
# ====================================================================

generate_config_template() {
    if [ ! -f "$CONFIG_FILE" ]; then
        log_info "ç”Ÿæˆé…ç½®æ–‡ä»¶æ¨¡æ¿..."
        
        cat > "$CONFIG_FILE" << 'EOF'
# SnapSync æ¢å¤å·¥å…·é…ç½®æ–‡ä»¶
# è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ä»¥ä¸‹é…ç½®

# è¿œç¨‹æœåŠ¡å™¨è¿æ¥ä¿¡æ¯
TARGET_IP=""              # è¿œç¨‹æœåŠ¡å™¨IPåœ°å€
TARGET_USER="root"        # SSHç”¨æˆ·å
SSH_PORT="22"            # SSHç«¯å£
REMOTE_BASE_PATH="/opt/system_backups"  # è¿œç¨‹å¤‡ä»½åŸºç¡€è·¯å¾„

# æœ¬åœ°è®¾ç½®
BACKUP_DIR="/opt/system_backups"         # æœ¬åœ°å¤‡ä»½ç›®å½•

# Telegramé€šçŸ¥è®¾ç½® (å¯é€‰)
TELEGRAM_BOT_TOKEN=""     # Telegramæœºå™¨äººToken
TELEGRAM_CHAT_ID=""       # TelegramèŠå¤©ID

# é«˜çº§é€‰é¡¹
VERIFY_CHECKSUMS="true"   # æ˜¯å¦éªŒè¯æ ¡éªŒå’Œ
PRESERVE_ACL="true"       # æ˜¯å¦ä¿ç•™ACLæƒé™
PRESERVE_XATTR="true"     # æ˜¯å¦ä¿ç•™æ‰©å±•å±æ€§
DEBUG_MODE="false"        # æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
EOF
        
        chmod 600 "$CONFIG_FILE"
        log_success "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: $CONFIG_FILE"
        echo -e "${YELLOW}è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶åé‡æ–°è¿è¡Œç¨‹åº${NC}"
        exit 0
    fi
}

# ====================================================================
# ä¸»ç¨‹åºå…¥å£ç‚¹
# ====================================================================

# æ£€æŸ¥æ˜¯å¦ä»¥rootæƒé™è¿è¡Œ
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}é”™è¯¯: æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œ${NC}"
    echo "è¯·ä½¿ç”¨: sudo $0"
    exit 1
fi

# è„šæœ¬åˆå§‹åŒ–
if ! initialize_script; then
    exit_with_error "è„šæœ¬åˆå§‹åŒ–å¤±è´¥"
fi

# ç”Ÿæˆé…ç½®æ¨¡æ¿ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
generate_config_template

# è¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥
if ! runtime_safety_check; then
    exit_with_error "è¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥å¤±è´¥"
fi

# æ¢å¤å‰ç³»ç»Ÿæ£€æŸ¥
if ! pre_restore_system_check; then
    log_warning "ç³»ç»Ÿæ£€æŸ¥æœªé€šè¿‡ï¼Œé€€å‡ºç¨‹åº"
    exit 1
fi

# æ‰§è¡Œä¸»ç¨‹åº
main "$@"

# ç¨‹åºç»“æŸ
log_info "====== SnapSync æ¢å¤å·¥å…·ç»“æŸ ======"
exit 0

# ====================================================================
# è„šæœ¬ç»“æŸæ ‡è®°
# ====================================================================
# SnapSync v2.5 Enhanced System Restore Tool
# ç‰ˆæƒæ‰€æœ‰ (c) 2024 SnapSync Development Team
# 
# æ­¤è„šæœ¬æä¾›ä»¥ä¸‹åŠŸèƒ½:
# - æœ¬åœ°å’Œè¿œç¨‹å¿«ç…§æ¢å¤
# - å¤šç§æ¢å¤æ¨¡å¼ï¼ˆæ ‡å‡†/å®Œå…¨/é€‰æ‹©æ€§ï¼‰
# - å¤šå‹ç¼©æ ¼å¼æ”¯æŒ
# - ACLå’Œæ‰©å±•å±æ€§æ¢å¤
# - å®Œæ•´æ€§éªŒè¯
# - Telegramé€šçŸ¥
# - æ™ºèƒ½é…ç½®ä¿ç•™
# - è¯¦ç»†çš„æ—¥å¿—è®°å½•
# - é”™è¯¯å¤„ç†å’Œæ¢å¤
# 
# ä½¿ç”¨å‰è¯·ä»”ç»†é˜…è¯»æ–‡æ¡£å’Œé…ç½®è¯´æ˜
# ====================================================================
EOF



