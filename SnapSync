#!/bin/bash

# SnapSync v2.5 å¢å¼ºç‰ˆ - å…¨ç›˜æ— æŸå¤‡ä»½ä¸æ¢å¤å·¥å…·
# ä¸»è¦æ”¹è¿›ï¼š
# 1. æ”¯æŒæ–‡ä»¶å±æ€§å’Œæƒé™å®Œæ•´ä¿ç•™
# 2. æ”¯æŒè½¯é“¾æ¥å’Œç¡¬é“¾æ¥
# 3. æ”¯æŒè®¾å¤‡æ–‡ä»¶å¤‡ä»½
# 4. æ”¯æŒæ‰©å±•å±æ€§å’ŒACL
# 5. åˆ†å±‚å¤‡ä»½ç­–ç•¥
# 6. å¢é‡å¤‡ä»½æ”¯æŒ
# 7. å¤‡ä»½å®Œæ•´æ€§éªŒè¯

# ====================================================================
# ## USER CONFIGURATION ##
# ====================================================================

# --- Telegram é…ç½® ---
BOT_TOKEN=""
CHAT_ID=""

# --- è¿œç¨‹ SSH æœåŠ¡å™¨é…ç½® ---
TARGET_IP=""
TARGET_USER="root"
SSH_PORT="22"
TARGET_BASE_DIR="/mnt/wd/Remote_backup"
REMOTE_DIR_NAME=""

# --- æœ¬åœ°é…ç½® ---
BACKUP_DIR="/backups"

# --- å¤‡ä»½ä¿ç•™ç­–ç•¥ ---
LOCAL_SNAPSHOT_KEEP="3"
REMOTE_SNAPSHOT_DAYS="30"

# --- è‡ªåŠ¨åŒ–é…ç½® ---
BACKUP_INTERVAL_DAYS="7"
RUN_NOW="Y"

# --- å¢å¼ºé…ç½® ---
DISK_SPACE_THRESHOLD="85"
MAX_RETRY_ATTEMPTS="3"
LOAD_THRESHOLD_MULTIPLIER="1.0"
MEMORY_THRESHOLD="80"

# --- æ–°å¢ï¼šå¤‡ä»½æ¨¡å¼é…ç½® ---
BACKUP_MODE="FULL"                    # FULL(å®Œæ•´), INCREMENTAL(å¢é‡)
ENABLE_COMPRESSION="Y"                # æ˜¯å¦å¯ç”¨å‹ç¼©
COMPRESSION_LEVEL="6"                 # å‹ç¼©çº§åˆ« 1-9
ENABLE_VERIFICATION="Y"               # æ˜¯å¦å¯ç”¨å¤‡ä»½éªŒè¯
ENABLE_ACL_BACKUP="Y"                 # æ˜¯å¦å¤‡ä»½ACLæƒé™
ENABLE_XATTR_BACKUP="Y"               # æ˜¯å¦å¤‡ä»½æ‰©å±•å±æ€§
PARALLEL_JOBS="auto"                  # å¹¶è¡Œä»»åŠ¡æ•°é‡

# ====================================================================
# æ ¸å¿ƒä»£ç 
# ====================================================================

# é¢œè‰²
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[0;33m'
BLUE='\033[0;34m'; CYAN='\033[0;36m'; NC='\033[0m'

# è·¯å¾„
CONFIG_DIR="/etc/system_snapshot"
CONFIG_FILE="$CONFIG_DIR/config.conf"
SCRIPT_DIR="/usr/local/sbin"
SCRIPT_FILE="$SCRIPT_DIR/system_snapshot.sh"
LOG_DIR="/var/log/system_snapshot"
INSTALL_LOG_FILE="$LOG_DIR/install.log"
SNAPSHOT_LOG_FILE="$LOG_DIR/snapshot.log"
DEBUG_LOG_FILE="$LOG_DIR/debug.log"

# SSH é…ç½®
SSH_KEY="/root/.ssh/id_ed25519"
SSH_OPTS='-o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/root/.ssh/known_hosts'

# å·¥å…·å‡½æ•°
ssh_cmd() { local host="$1"; shift; eval ssh -i "\"$SSH_KEY\"" -p "\"$SSH_PORT\"" $SSH_OPTS "\"$host\"" "\"$@\""; }
scp_cmd() { eval scp -i "\"$SSH_KEY\"" -P "\"$SSH_PORT\"" -o IdentitiesOnly=yes "\"$@\""; }
log() { mkdir -p "$LOG_DIR"; echo -e "$(date '+%F %T') $1" | tee -a "$INSTALL_LOG_FILE"; }
error_exit() { log "${RED}é”™è¯¯: $1${NC}"; exit 1; }
show_title() { echo -e "\n${BLUE}============================================================${NC}\n${CYAN}$1${NC}\n${BLUE}============================================================${NC}\n"; }

# æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
check_requirements() {
    [ "$EUID" -ne 0 ] && error_exit "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œ"
    
    # åŸºç¡€å·¥å…·
    local required_tools="curl ssh rsync tar git hostname jq bc find xargs"
    for cmd in $required_tools; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            log "${YELLOW}å®‰è£… $cmd...${NC}"
            apt-get update && apt-get install -y "$cmd" || error_exit "æ— æ³•å®‰è£… $cmd"
        fi
    done
    
    # å‹ç¼©å·¥å…·
    if ! command -v pigz >/dev/null 2>&1; then
        log "${YELLOW}å®‰è£…å¤šçº¿ç¨‹å‹ç¼©å·¥å…· pigz...${NC}"
        apt-get install -y pigz >/dev/null 2>&1 || log "${YELLOW}pigz å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨æ ‡å‡† gzip${NC}"
    fi
    
    # ACL æ”¯æŒ
    if [[ "$ENABLE_ACL_BACKUP" == "Y" ]]; then
        if ! command -v getfacl >/dev/null 2>&1 || ! command -v setfacl >/dev/null 2>&1; then
            log "${YELLOW}å®‰è£… ACL æ”¯æŒå·¥å…·...${NC}"
            apt-get install -y acl || log "${YELLOW}ACL å·¥å…·å®‰è£…å¤±è´¥ï¼Œå°†è·³è¿‡ ACL å¤‡ä»½${NC}"
        fi
    fi
    
    # æ‰©å±•å±æ€§æ”¯æŒ
    if [[ "$ENABLE_XATTR_BACKUP" == "Y" ]]; then
        if ! command -v getfattr >/dev/null 2>&1 || ! command -v setfattr >/dev/null 2>&1; then
            log "${YELLOW}å®‰è£…æ‰©å±•å±æ€§æ”¯æŒå·¥å…·...${NC}"
            apt-get install -y attr || log "${YELLOW}æ‰©å±•å±æ€§å·¥å…·å®‰è£…å¤±è´¥ï¼Œå°†è·³è¿‡æ‰©å±•å±æ€§å¤‡ä»½${NC}"
        fi
    fi
    
    # æ ¡éªŒå·¥å…·
    if [[ "$ENABLE_VERIFICATION" == "Y" ]]; then
        for tool in sha256sum md5sum; do
            command -v "$tool" >/dev/null 2>&1 || apt-get install -y coreutils
        done
    fi
}

# é…ç½®éªŒè¯
validate_config() {
    for param in BOT_TOKEN CHAT_ID TARGET_IP; do
        [ -z "${!param}" ] && error_exit "é…ç½®å‚æ•° $param ä¸èƒ½ä¸ºç©º"
    done
    
    [[ "$SSH_PORT" =~ ^[0-9]+$ ]] && [ "$SSH_PORT" -ge 1 ] && [ "$SSH_PORT" -le 65535 ] || error_exit "SSHç«¯å£æ— æ•ˆ: $SSH_PORT"
    [[ "$COMPRESSION_LEVEL" =~ ^[1-9]$ ]] || COMPRESSION_LEVEL="6"
    
    # å¹¶è¡Œä»»åŠ¡æ•°è‡ªåŠ¨æ£€æµ‹
    if [[ "$PARALLEL_JOBS" == "auto" ]]; then
        PARALLEL_JOBS=$(nproc)
        log "${CYAN}è‡ªåŠ¨æ£€æµ‹åˆ° CPU æ ¸å¿ƒæ•°: $PARALLEL_JOBS${NC}"
    fi
}

# æ”¶é›†é…ç½®
collect_config() {
    show_title "SnapSync v2.5 å¢å¼ºç‰ˆé…ç½®å‘å¯¼"
    log "${CYAN}ğŸš€ å…¨ç›˜æ— æŸå¤‡ä»½ä¸æ¢å¤å·¥å…·${NC}"
    log "${CYAN}æ–°ç‰¹æ€§: æ”¯æŒæ–‡ä»¶å±æ€§ã€ACLã€æ‰©å±•å±æ€§ã€å¢é‡å¤‡ä»½${NC}\n"

    log "${YELLOW}ğŸ“± Telegram é€šçŸ¥é…ç½®:${NC}"
    read -p "è¯·è¾“å…¥ Telegram Bot Token [å½“å‰: ${BOT_TOKEN:0:8}...]: " INPUT
    BOT_TOKEN=${INPUT:-$BOT_TOKEN}
    while [ -z "$BOT_TOKEN" ]; do read -p "è¯·è¾“å…¥ Telegram Bot Token: " BOT_TOKEN; done
    
    read -p "è¯·è¾“å…¥ Telegram Chat ID [å½“å‰: $CHAT_ID]: " INPUT
    CHAT_ID=${INPUT:-$CHAT_ID}
    while [ -z "$CHAT_ID" ]; do read -p "è¯·è¾“å…¥ Telegram Chat ID: " CHAT_ID; done
    echo

    log "${YELLOW}ğŸŒ è¿œç¨‹æœåŠ¡å™¨é…ç½®:${NC}"
    read -p "è¯·è¾“å…¥è¿œç¨‹æœåŠ¡å™¨IPåœ°å€ [å½“å‰: $TARGET_IP]: " INPUT
    TARGET_IP=${INPUT:-$TARGET_IP}
    while [ -z "$TARGET_IP" ]; do read -p "è¯·è¾“å…¥è¿œç¨‹æœåŠ¡å™¨IPåœ°å€: " TARGET_IP; done
    
    read -p "è¯·è¾“å…¥è¿œç¨‹æœåŠ¡å™¨ç”¨æˆ·å [é»˜è®¤: $TARGET_USER]: " INPUT
    TARGET_USER=${INPUT:-$TARGET_USER}
    
    read -p "è¯·è¾“å…¥SSHç«¯å£ [é»˜è®¤: $SSH_PORT]: " INPUT
    SSH_PORT=${INPUT:-$SSH_PORT}
    echo

    log "${YELLOW}ğŸ“ å­˜å‚¨é…ç½®:${NC}"
    read -p "è¯·è¾“å…¥è¿œç¨‹åŸºç¡€å¤‡ä»½ç›®å½• [é»˜è®¤: $TARGET_BASE_DIR]: " INPUT
    TARGET_BASE_DIR=${INPUT:-$TARGET_BASE_DIR}

    HOSTNAME=$(hostname)
    if [ -z "$REMOTE_DIR_NAME" ]; then
        REMOTE_DIR_NAME="$HOSTNAME"
        log "${CYAN}æœ¬æœºå°†åœ¨è¿œç¨‹åˆ›å»ºç›®å½•: $TARGET_BASE_DIR/$REMOTE_DIR_NAME${NC}"
        read -p "æ˜¯å¦ä½¿ç”¨æ­¤é»˜è®¤ç›®å½•å '$REMOTE_DIR_NAME'? [Y/n]: " USE_DEFAULT_HOSTNAME
        if [[ "$USE_DEFAULT_HOSTNAME" =~ ^[Nn]$ ]]; then
            read -p "è¯·è¾“å…¥è‡ªå®šä¹‰ç›®å½•å: " REMOTE_DIR_NAME
            while [ -z "$REMOTE_DIR_NAME" ]; do 
                read -p "ç›®å½•åä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥: " REMOTE_DIR_NAME
            done
        fi
    fi

    read -p "è¯·è¾“å…¥æœ¬åœ°å¤‡ä»½ç›®å½• [é»˜è®¤: $BACKUP_DIR]: " INPUT
    BACKUP_DIR=${INPUT:-$BACKUP_DIR}
    echo

    log "${YELLOW}ğŸ”§ å¤‡ä»½æ¨¡å¼é…ç½®:${NC}"
    echo "å¤‡ä»½æ¨¡å¼é€‰æ‹©:"
    echo "1) FULL - å®Œæ•´å¤‡ä»½ï¼ˆæ¨èï¼‰"
    echo "2) INCREMENTAL - å¢é‡å¤‡ä»½ï¼ˆå®éªŒæ€§ï¼‰"
    read -p "é€‰æ‹©å¤‡ä»½æ¨¡å¼ [1-2ï¼Œé»˜è®¤: 1]: " MODE_CHOICE
    case "$MODE_CHOICE" in
        2) BACKUP_MODE="INCREMENTAL" ;;
        *) BACKUP_MODE="FULL" ;;
    esac
    
    read -p "å¯ç”¨å‹ç¼©? [Y/n]: " INPUT
    ENABLE_COMPRESSION=${INPUT:-$ENABLE_COMPRESSION}
    
    if [[ "$ENABLE_COMPRESSION" =~ ^[Yy]$ ]]; then
        read -p "å‹ç¼©çº§åˆ« (1-9ï¼Œé»˜è®¤: $COMPRESSION_LEVEL): " INPUT
        COMPRESSION_LEVEL=${INPUT:-$COMPRESSION_LEVEL}
    fi
    
    read -p "å¯ç”¨å¤‡ä»½éªŒè¯? [Y/n]: " INPUT
    ENABLE_VERIFICATION=${INPUT:-$ENABLE_VERIFICATION}
    
    read -p "å¤‡ä»½ACLæƒé™? [Y/n]: " INPUT
    ENABLE_ACL_BACKUP=${INPUT:-$ENABLE_ACL_BACKUP}
    
    read -p "å¤‡ä»½æ‰©å±•å±æ€§? [Y/n]: " INPUT
    ENABLE_XATTR_BACKUP=${INPUT:-$ENABLE_XATTR_BACKUP}
    echo

    log "${YELLOW}ğŸ—„ï¸ ä¿ç•™ç­–ç•¥:${NC}"
    read -p "æœ¬åœ°ä¿ç•™å¿«ç…§æ•°é‡ [é»˜è®¤: $LOCAL_SNAPSHOT_KEEP]: " INPUT
    LOCAL_SNAPSHOT_KEEP=${INPUT:-$LOCAL_SNAPSHOT_KEEP}
    
    read -p "è¿œç¨‹å¿«ç…§ä¿ç•™å¤©æ•° [é»˜è®¤: $REMOTE_SNAPSHOT_DAYS]: " INPUT
    REMOTE_SNAPSHOT_DAYS=${INPUT:-$REMOTE_SNAPSHOT_DAYS}
    echo

    log "${YELLOW}â° å®šæ—¶é…ç½®:${NC}"
    read -p "å¤‡ä»½é—´éš”å¤©æ•° (1-30ï¼Œé»˜è®¤: $BACKUP_INTERVAL_DAYS): " INPUT
    BACKUP_INTERVAL_DAYS=${INPUT:-$BACKUP_INTERVAL_DAYS}
    while [[ ! "$BACKUP_INTERVAL_DAYS" =~ ^([1-9]|[12][0-9]|30)$ ]]; do 
        read -p "è¯·è¾“å…¥1-30ä¹‹é—´çš„æ•°å­—: " INPUT
        BACKUP_INTERVAL_DAYS=${INPUT:-7}
    done
    
    read -p "ç«‹å³æ‰§è¡Œæµ‹è¯•å¤‡ä»½? [Y/n]: " INPUT
    RUN_NOW=${INPUT:-$RUN_NOW}
    echo

    validate_config
    
    # é…ç½®é¢„è§ˆ
    show_title "é…ç½®é¢„è§ˆ"
    log "${CYAN}è¿œç¨‹æœåŠ¡å™¨:${NC} $TARGET_USER@$TARGET_IP:$SSH_PORT"
    log "${CYAN}è¿œç¨‹è·¯å¾„:${NC} $TARGET_BASE_DIR/$REMOTE_DIR_NAME"
    log "${CYAN}æœ¬åœ°è·¯å¾„:${NC} $BACKUP_DIR"
    log "${CYAN}å¤‡ä»½æ¨¡å¼:${NC} $BACKUP_MODE"
    log "${CYAN}å‹ç¼©è®¾ç½®:${NC} $ENABLE_COMPRESSION (çº§åˆ«: $COMPRESSION_LEVEL)"
    log "${CYAN}é«˜çº§ç‰¹æ€§:${NC} ACL:$ENABLE_ACL_BACKUP, XATTR:$ENABLE_XATTR_BACKUP, éªŒè¯:$ENABLE_VERIFICATION"
    log "${CYAN}ä¿ç•™ç­–ç•¥:${NC} æœ¬åœ°${LOCAL_SNAPSHOT_KEEP}ä¸ªï¼Œè¿œç¨‹${REMOTE_SNAPSHOT_DAYS}å¤©"
    log "${CYAN}æ‰§è¡Œé¢‘ç‡:${NC} æ¯${BACKUP_INTERVAL_DAYS}å¤©\n"

    read -p "ç¡®è®¤é…ç½®å¹¶ç»§ç»­? [Y/n]: " CONFIRM_CONFIG
    [[ "$CONFIRM_CONFIG" =~ ^[Nn]$ ]] && { 
        log "\n${YELLOW}é…ç½®å·²å–æ¶ˆï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬${NC}"; exit 0; 
    }
}

# SSH å¯†é’¥é…ç½®
setup_ssh_key() {
    show_title "SSH å¯†é’¥é…ç½®"
    mkdir -p /root/.ssh; chmod 700 /root/.ssh
    
    if [ ! -f "$SSH_KEY" ]; then
        log "${YELLOW}ç”Ÿæˆæ–°çš„ Ed25519 SSH å¯†é’¥...${NC}"
        ssh-keygen -t ed25519 -N "" -f "$SSH_KEY" -q
        log "${GREEN}âœ“ SSH å¯†é’¥ç”Ÿæˆå®Œæˆ${NC}"
    fi
    
    log "${YELLOW}è¯·å°†ä»¥ä¸‹å…¬é’¥æ·»åŠ åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š${NC}"
    echo -e "${GREEN}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    cat "${SSH_KEY}.pub"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
    echo -e "${CYAN}æ·»åŠ æ–¹æ³•ï¼š${NC}"
    echo -e "  ${CYAN}OpenSSHï¼š${NC}echo '$(cat ${SSH_KEY}.pub)' >> ~/.ssh/authorized_keys"
    echo -e "  ${CYAN}Dropbearï¼š${NC}echo '$(cat ${SSH_KEY}.pub)' >> /etc/dropbear/authorized_keys\n"
    
    read -p "å·²æ·»åŠ å…¬é’¥åˆ°è¿œç¨‹æœåŠ¡å™¨? [Y/n]: " SSH_OK
    
    if [[ ! "$SSH_OK" =~ ^[Nn]$ ]]; then
        log "${YELLOW}æµ‹è¯• SSH è¿æ¥...${NC}"
        if ssh_cmd "$TARGET_USER@$TARGET_IP" "echo 'SSHæµ‹è¯•æˆåŠŸ'" >/dev/null 2>&1; then
            log "${GREEN}âœ“ SSH è¿æ¥æµ‹è¯•æˆåŠŸï¼${NC}"
            
            # åˆ›å»ºè¿œç¨‹ç›®å½•ç»“æ„
            log "${YELLOW}åˆ›å»ºè¿œç¨‹ç›®å½•ç»“æ„...${NC}"
            FULL_REMOTE_PATH="$TARGET_BASE_DIR/$REMOTE_DIR_NAME"
            if ssh_cmd "$TARGET_USER@$TARGET_IP" "mkdir -p '$FULL_REMOTE_PATH'/{system_snapshots,metadata,logs,checksums}"; then
                log "${GREEN}âœ“ è¿œç¨‹ç›®å½•åˆ›å»ºæˆåŠŸ: $FULL_REMOTE_PATH${NC}"
            else
                log "${YELLOW}âš  è¿œç¨‹ç›®å½•åˆ›å»ºå¯èƒ½å¤±è´¥${NC}"
            fi
        else
            log "${RED}âœ— SSH è¿æ¥å¤±è´¥${NC}"
            echo -e "${YELLOW}è¯·æ£€æŸ¥ï¼š${NC}"
            echo "1. å…¬é’¥æ˜¯å¦æ­£ç¡®æ·»åŠ "
            echo "2. SSHç«¯å£æ˜¯å¦æ­£ç¡® (å½“å‰: $SSH_PORT)"
            echo "3. è¿œç¨‹æœåŠ¡å™¨æ˜¯å¦å¯è¾¾"
            echo "4. é˜²ç«å¢™è®¾ç½®"
            read -p "ç»§ç»­å®‰è£…? (å°†è·³è¿‡è¿œç¨‹åŠŸèƒ½) [y/N]: " CONTINUE
            [[ ! "$CONTINUE" =~ ^[Yy]$ ]] && exit 1
        fi
    fi
}

# Telegram æµ‹è¯•
test_telegram() {
    show_title "Telegram é€šçŸ¥æµ‹è¯•"
    local msg="ğŸš€ SnapSync v2.5 å®‰è£…æµ‹è¯•\næ—¶é—´: $(date '+%F %T')\nä¸»æœº: $(hostname)\næ¨¡å¼: $BACKUP_MODE"
    local rendered=$(printf "%b" "$msg")
    
    response=$(curl -s -m 10 "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" \
        --data-urlencode text="$rendered")
    
    if [[ $response == *"\"ok\":true"* ]]; then
        log "${GREEN}âœ“ Telegram é€šçŸ¥æµ‹è¯•æˆåŠŸï¼${NC}\n"
    else
        log "${RED}âœ— Telegram é€šçŸ¥å‘é€å¤±è´¥${NC}"
        log "${YELLOW}å“åº”: $response${NC}\n"
    fi
}

# åˆ›å»ºå¢å¼ºç‰ˆå¤‡ä»½è„šæœ¬
create_enhanced_script() {
    show_title "åˆ›å»ºå¢å¼ºç‰ˆå¤‡ä»½è„šæœ¬"
    mkdir -p "$BACKUP_DIR" "$CONFIG_DIR" "$SCRIPT_DIR" "$LOG_DIR"

    log "${YELLOW}åˆ›å»ºé…ç½®æ–‡ä»¶...${NC}"
    cat > "$CONFIG_FILE" << EOF
#!/bin/bash
# SnapSync v2.5 é…ç½®æ–‡ä»¶ (ç”Ÿæˆæ—¶é—´: $(date '+%F %T'))

# åŸºç¡€é…ç½®
BOT_TOKEN="$BOT_TOKEN"
CHAT_ID="$CHAT_ID"
TARGET_IP="$TARGET_IP"
TARGET_USER="$TARGET_USER"
SSH_PORT="$SSH_PORT"
TARGET_BASE_DIR="$TARGET_BASE_DIR"
REMOTE_DIR_NAME="$REMOTE_DIR_NAME"
BACKUP_DIR="$BACKUP_DIR"
HOSTNAME=\$(hostname)

# ä¿ç•™ç­–ç•¥
LOCAL_SNAPSHOT_KEEP=$LOCAL_SNAPSHOT_KEEP
REMOTE_SNAPSHOT_DAYS=$REMOTE_SNAPSHOT_DAYS
BACKUP_INTERVAL_DAYS=$BACKUP_INTERVAL_DAYS

# ç³»ç»Ÿé˜ˆå€¼
DISK_SPACE_THRESHOLD="$DISK_SPACE_THRESHOLD"
MAX_RETRY_ATTEMPTS="$MAX_RETRY_ATTEMPTS"
LOAD_THRESHOLD_MULTIPLIER="$LOAD_THRESHOLD_MULTIPLIER"
MEMORY_THRESHOLD="$MEMORY_THRESHOLD"

# å¢å¼ºç‰¹æ€§
BACKUP_MODE="$BACKUP_MODE"
ENABLE_COMPRESSION="$ENABLE_COMPRESSION"
COMPRESSION_LEVEL="$COMPRESSION_LEVEL"
ENABLE_VERIFICATION="$ENABLE_VERIFICATION"
ENABLE_ACL_BACKUP="$ENABLE_ACL_BACKUP"
ENABLE_XATTR_BACKUP="$ENABLE_XATTR_BACKUP"
PARALLEL_JOBS="$PARALLEL_JOBS"

# æ—¥å¿—æ–‡ä»¶
LOG_FILE="$SNAPSHOT_LOG_FILE"
DEBUG_LOG="$DEBUG_LOG_FILE"
EOF

    log "${YELLOW}åˆ›å»ºå¢å¼ºç‰ˆå¤‡ä»½è„šæœ¬...${NC}"
    cat > "$SCRIPT_FILE" << 'SCRIPT_EOF'
#!/bin/bash

# SnapSync v2.5 å¢å¼ºç‰ˆå¤‡ä»½è„šæœ¬
source "/etc/system_snapshot/config.conf" || { echo "é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°"; exit 1; }

# å…¨å±€å˜é‡
TIMESTAMP=$(date +"%Y%m%d%H%M%S")
SNAPSHOT_NAME="system_snapshot_${TIMESTAMP}"
SNAPSHOT_FILE="$BACKUP_DIR/${SNAPSHOT_NAME}.tar"
METADATA_DIR="$BACKUP_DIR/metadata"
LOCK_FILE="/tmp/system_snapshot.lock"

# SSH é…ç½®
SSH_KEY="/root/.ssh/id_ed25519"
SSH_OPTS='-o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/root/.ssh/known_hosts'
ssh_cmd() { local host="$1"; shift; eval ssh -i "\"$SSH_KEY\"" -p "\"$SSH_PORT\"" $SSH_OPTS "\"$host\"" "\"$@\""; }

# è¿›ç¨‹é”
exec 200>"$LOCK_FILE"
if ! flock -n 200; then
    echo "å¤‡ä»½è„šæœ¬å·²åœ¨è¿è¡Œä¸­"
    exit 1
fi
echo $$ >&200
trap 'flock -u 200; cleanup_on_exit' EXIT

# æ—¥å¿—å‡½æ•°
log_info() { echo "$(date '+%F %T') [INFO] $1" | tee -a "$LOG_FILE"; }
log_error() { echo "$(date '+%F %T') [ERROR] $1" | tee -a "$LOG_FILE"; }
log_debug() { echo "$(date '+%F %T') [DEBUG] $1" >> "$DEBUG_LOG"; }

# Telegram é€šçŸ¥
send_tg() {
    [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ] && return 0
    local rendered=$(printf "%b" "$1")
    curl -sS -m 15 "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" --data-urlencode text="$rendered" >/dev/null 2>&1 || true
}

# æ¸…ç†å‡½æ•°
cleanup_on_exit() {
    if [ -f "$SNAPSHOT_FILE.tmp" ]; then
        log_info "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f "$SNAPSHOT_FILE.tmp"
    fi
}

# é‡è¯•æœºåˆ¶
retry_command() {
    local max="${MAX_RETRY_ATTEMPTS:-3}"
    local attempt=1
    while [ $attempt -le $max ]; do
        if eval "$@"; then
            return 0
        fi
        log_info "å‘½ä»¤å¤±è´¥ï¼Œç¬¬ $attempt æ¬¡é‡è¯•... (æœ€å¤§: $max)"
        sleep $((attempt * 3))
        attempt=$((attempt + 1))
    done
    return 1
}

# å­—èŠ‚æ ¼å¼åŒ–
format_bytes() {
    local bytes="$1"
    if [[ ! "$bytes" =~ ^[0-9]+$ ]]; then
        echo "0B"
        return
    fi
    
    if [ "$bytes" -ge 1073741824 ]; then
        echo "$((bytes / 1073741824)).$(((bytes % 1073741824) * 10 / 1073741824))GB"
    elif [ "$bytes" -ge 1048576 ]; then
        echo "$((bytes / 1048576)).$(((bytes % 1048576) * 10 / 1048576))MB"
    elif [ "$bytes" -ge 1024 ]; then
        echo "$((bytes / 1024)).$(((bytes % 1024) * 10 / 1024))KB"
    else
        echo "${bytes}B"
    fi
}

# ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
check_system_resources() {
    log_info "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
    
    # ç£ç›˜ç©ºé—´æ£€æŸ¥
    local disk_info=$(df "$BACKUP_DIR" 2>/dev/null | tail -n1)
    if [ -z "$disk_info" ]; then
        log_error "æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
        return 1
    fi
    
    local usage=$(echo "$disk_info" | awk '{print $5}' | tr -d '%')
    if [[ ! "$usage" =~ ^[0-9]+$ ]]; then
        log_error "æ— æ³•è§£æç£ç›˜ä½¿ç”¨ç‡"
        return 1
    fi
    
    if [ "$usage" -gt "${DISK_SPACE_THRESHOLD:-85}" ]; then
        log_error "ç£ç›˜ç©ºé—´ä¸è¶³: ${usage}% > ${DISK_SPACE_THRESHOLD}%"
        send_tg "âŒ å¤‡ä»½å¤±è´¥\nç£ç›˜ä½¿ç”¨ç‡: ${usage}% > ${DISK_SPACE_THRESHOLD}%\nä¸»æœº: $(hostname)\næ—¶é—´: $(date '+%F %T')"
        return 1
    fi
    
    # è´Ÿè½½æ£€æŸ¥
    local load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk -F',' '{print $1}' | tr -d ' ')
    local cpu_cores=$(nproc)
    local load_threshold=$(echo "$cpu_cores * $LOAD_THRESHOLD_MULTIPLIER" | bc -l)
    
    if [ -n "$load_avg" ] && (( $(echo "$load_avg > $load_threshold" | bc -l) )); then
        log_info "ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜: $load_avg > $load_thresholdï¼Œå°†é™ä½å¤‡ä»½ä¼˜å…ˆçº§"
        renice 10 $$
    fi
    
    # å†…å­˜æ£€æŸ¥
    local mem_info=$(free | awk '/^Mem:/ {printf "%.0f", $3/$2 * 100.0}')
    if [ -n "$mem_info" ] && [ "$mem_info" -gt "${MEMORY_THRESHOLD:-80}" ]; then
        log_info "å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜: ${mem_info}%ï¼Œå¯ç”¨å†…å­˜ä¼˜åŒ–æ¨¡å¼"
        export GZIP_OPT="-1"  # é™ä½å‹ç¼©çº§åˆ«ä»¥èŠ‚çœå†…å­˜
    fi
    
    log_info "ç³»ç»Ÿèµ„æºæ£€æŸ¥å®Œæˆ - ç£ç›˜: ${usage}%, è´Ÿè½½: ${load_avg}, å†…å­˜: ${mem_info}%"
}

# åˆ›å»ºå…ƒæ•°æ®å¤‡ä»½
backup_metadata() {
    log_info "å¤‡ä»½ç³»ç»Ÿå…ƒæ•°æ®..."
    mkdir -p "$METADATA_DIR"
    
    # æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯
    mount > "$METADATA_DIR/mount_info.txt"
    df -h > "$METADATA_DIR/filesystem_info.txt"
    lsblk > "$METADATA_DIR/block_devices.txt"
    cat /etc/fstab > "$METADATA_DIR/fstab.txt"
    
    # ç³»ç»Ÿä¿¡æ¯
    uname -a > "$METADATA_DIR/system_info.txt"
    cat /proc/cpuinfo > "$METADATA_DIR/cpu_info.txt"
    cat /proc/meminfo > "$METADATA_DIR/memory_info.txt"
    dpkg -l > "$METADATA_DIR/installed_packages.txt" 2>/dev/null || \
    rpm -qa > "$METADATA_DIR/installed_packages.txt" 2>/dev/null || true
    
    # ç½‘ç»œé…ç½®
    ip addr show > "$METADATA_DIR/network_interfaces.txt"
    ip route show > "$METADATA_DIR/routes.txt"
    cat /etc/resolv.conf > "$METADATA_DIR/dns.txt" 2>/dev/null || true
    
    # ç”¨æˆ·å’Œç»„
    cp /etc/passwd "$METADATA_DIR/"
    cp /etc/group "$METADATA_DIR/"
    cp /etc/shadow "$METADATA_DIR/" 2>/dev/null || true
    
    # æœåŠ¡çŠ¶æ€
    systemctl list-units --all > "$METADATA_DIR/systemd_units.txt" 2>/dev/null || true
    systemctl list-unit-files > "$METADATA_DIR/systemd_unit_files.txt" 2>/dev/null || true
    
    # ACL å’Œæ‰©å±•å±æ€§
    if [[ "$ENABLE_ACL_BACKUP" == "Y" ]] && command -v getfacl >/dev/null 2>&1; then
        log_info "å¤‡ä»½ ACL æƒé™..."
        find /etc /usr /var /root /home -type f -o -type d | \
        head -10000 | xargs getfacl 2>/dev/null > "$METADATA_DIR/acl_backup.txt" || true
    fi
    
    if [[ "$ENABLE_XATTR_BACKUP" == "Y" ]] && command -v getfattr >/dev/null 2>&1; then
        log_info "å¤‡ä»½æ‰©å±•å±æ€§..."
        find /etc /usr /var /root /home -type f -o -type d | \
        head -10000 | xargs getfattr -d -m - 2>/dev/null > "$METADATA_DIR/xattr_backup.txt" || true
    fi
    
    log_info "å…ƒæ•°æ®å¤‡ä»½å®Œæˆ"
}

# å¢é‡å¤‡ä»½æ”¯æŒ
get_last_backup_timestamp() {
    if [ "$BACKUP_MODE" = "INCREMENTAL" ]; then
        local last_backup=$(find "$BACKUP_DIR" -name "system_snapshot_*.tar*" -type f | \
                           sed 's/.*system_snapshot_\([0-9]\{14\}\).*/\1/' | sort -r | head -1)
        if [ -n "$last_backup" ]; then
            echo "$last_backup"
        else
            echo ""
        fi
    else
        echo ""
    fi
}

# åˆ›å»ºé«˜çº§ç³»ç»Ÿå¿«ç…§
create_enhanced_snapshot() {
    local start_time=$(date +%s)
    
    send_tg "ğŸ”„ å¼€å§‹åˆ›å»ºå¢å¼ºç‰ˆç³»ç»Ÿå¿«ç…§\nä¸»æœº: $(hostname)\næ¨¡å¼: $BACKUP_MODE\næ—¶é—´: $(date '+%F %T')\nç‰¹æ€§: ACL:$ENABLE_ACL_BACKUP XATTR:$ENABLE_XATTR_BACKUP"
    
    log_info "å¼€å§‹åˆ›å»ºå¢å¼ºç‰ˆç³»ç»Ÿå¿«ç…§ (æ¨¡å¼: $BACKUP_MODE)..."
    
    # ç³»ç»Ÿèµ„æºæ£€æŸ¥
    check_system_resources || return 1
    
    # å¤‡ä»½å…ƒæ•°æ®
    backup_metadata
    
    # ç¡®å®šå‹ç¼©å·¥å…·å’Œå‚æ•°
    local compress_cmd="cat"
    local compress_ext=""
    
    if [[ "$ENABLE_COMPRESSION" == "Y" ]]; then
        if command -v pigz >/dev/null 2>&1; then
            compress_cmd="pigz -${COMPRESSION_LEVEL} -p ${PARALLEL_JOBS}"
            compress_ext=".gz"
            log_info "ä½¿ç”¨ pigz å¤šçº¿ç¨‹å‹ç¼© (çº§åˆ«: $COMPRESSION_LEVEL, çº¿ç¨‹: $PARALLEL_JOBS)"
        else
            compress_cmd="gzip -${COMPRESSION_LEVEL}"
            compress_ext=".gz"
            log_info "ä½¿ç”¨ gzip å‹ç¼© (çº§åˆ«: $COMPRESSION_LEVEL)"
        fi
    fi
    
    # è®¾ç½®æœ€ç»ˆæ–‡ä»¶å
    SNAPSHOT_FILE="${SNAPSHOT_FILE}${compress_ext}"
    local temp_file="${SNAPSHOT_FILE}.tmp"
    
    # æ„å»º tar å‚æ•°
    local tar_opts="--create --file=-"
    tar_opts="$tar_opts --preserve-permissions --same-owner"
    tar_opts="$tar_opts --numeric-owner --sparse"
    tar_opts="$tar_opts --warning=no-file-changed --warning=no-file-removed"
    
    # æ·»åŠ  ACL å’Œæ‰©å±•å±æ€§æ”¯æŒ
    if [[ "$ENABLE_ACL_BACKUP" == "Y" ]] && command -v getfacl >/dev/null 2>&1; then
        tar_opts="$tar_opts --acls"
        log_info "å¯ç”¨ ACL å¤‡ä»½"
    fi
    
    if [[ "$ENABLE_XATTR_BACKUP" == "Y" ]] && command -v getfattr >/dev/null 2>&1; then
        tar_opts="$tar_opts --xattrs --xattrs-include='*'"
        log_info "å¯ç”¨æ‰©å±•å±æ€§å¤‡ä»½"
    fi
    
    # å¢é‡å¤‡ä»½æ”¯æŒ
    local incremental_opts=""
    if [ "$BACKUP_MODE" = "INCREMENTAL" ]; then
        local last_timestamp=$(get_last_backup_timestamp)
        if [ -n "$last_timestamp" ]; then
            local snapshot_file="$BACKUP_DIR/snapshot.snar"
            incremental_opts="--listed-incremental=$snapshot_file"
            log_info "å¢é‡å¤‡ä»½æ¨¡å¼ï¼ŒåŸºäºå¿«ç…§: $last_timestamp"
        else
            log_info "æœªæ‰¾åˆ°åŸºç¡€å¿«ç…§ï¼Œæ‰§è¡Œå®Œæ•´å¤‡ä»½"
        fi
    fi
    
    # å®šä¹‰æ’é™¤åˆ—è¡¨
    local excludes=(
        "dev/*" "proc/*" "sys/*" "tmp/*" "run/*"
        "mnt/*" "media/*" "lost+found"
        "var/cache/*" "var/tmp/*" "var/log/*"
        "var/lib/apt/lists/*" "var/lib/docker/overlay2/*"
        "var/lib/systemd/coredump/*"
        "$BACKUP_DIR/*" "*.log" "*.tmp" "*.swp"
        "swap*" "core" ".cache/*" "*.core"
        ".thumbnails/*" ".gvfs/*" ".trash/*"
        "*.iso" "*.img" "lost+found"
        "home/*/.cache/*" "home/*/.local/share/Trash/*"
        "root/.cache/*" "root/.local/share/Trash/*"
    )
    
    # æ„å»ºæ’é™¤å‚æ•°
    local exclude_opts=""
    for exclude in "${excludes[@]}"; do
        exclude_opts="$exclude_opts --exclude='$exclude'"
    done
    
    # åŒ…å«çš„ç›®å½•åˆ—è¡¨
    local include_dirs=(
        "etc" "usr" "var" "root" "home" "opt"
        "boot" "srv" "lib" "lib64"
    )
    
    log_info "å¼€å§‹åˆ›å»ºtarå½’æ¡£..."
    log_debug "tarå‘½ä»¤: tar $tar_opts $incremental_opts $exclude_opts ${include_dirs[*]}"
    
    # æ‰§è¡Œå¤‡ä»½
    cd / && {
        eval tar $tar_opts $incremental_opts $exclude_opts "${include_dirs[@]}" 2>/tmp/snapshot_error.log | \
        $compress_cmd > "$temp_file"
    }
    
    local tar_exit=$?
    
    # æ£€æŸ¥å¤‡ä»½ç»“æœ
    if [ $tar_exit -ne 0 ] || [ ! -s "$temp_file" ]; then
        local error_msg=$(cat /tmp/snapshot_error.log 2>/dev/null || echo "æœªçŸ¥é”™è¯¯")
        log_error "å¿«ç…§åˆ›å»ºå¤±è´¥ (é€€å‡ºç : $tar_exit): $error_msg"
        send_tg "âŒ å¿«ç…§åˆ›å»ºå¤±è´¥\né”™è¯¯: $error_msg\né€€å‡ºç : $tar_exit\næ—¶é—´: $(date '+%F %T')"
        rm -f "$temp_file"
        return 1
    fi
    
    # ç§»åŠ¨ä¸´æ—¶æ–‡ä»¶åˆ°æœ€ç»ˆä½ç½®
    mv "$temp_file" "$SNAPSHOT_FILE"
    
    # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local size_bytes=$(stat -c%s "$SNAPSHOT_FILE" 2>/dev/null || echo 0)
    local size_human=$(format_bytes $size_bytes)
    
    log_info "å¿«ç…§åˆ›å»ºæˆåŠŸ: $(basename $SNAPSHOT_FILE)"
    log_info "æ–‡ä»¶å¤§å°: $size_human, è€—æ—¶: ${duration}ç§’"
    
    # ç”Ÿæˆæ ¡éªŒå’Œ
    if [[ "$ENABLE_VERIFICATION" == "Y" ]]; then
        log_info "ç”Ÿæˆæ ¡éªŒå’Œ..."
        local checksum_file="${SNAPSHOT_FILE}.sha256"
        sha256sum "$SNAPSHOT_FILE" > "$checksum_file"
        log_info "æ ¡éªŒå’Œå·²ä¿å­˜: $(basename $checksum_file)"
        
        # æ·»åŠ åˆ°å…ƒæ•°æ®
        echo "$(basename $SNAPSHOT_FILE) $(cat $checksum_file | cut -d' ' -f1)" >> "$METADATA_DIR/checksums.txt"
    fi
    
    send_tg "ğŸ“¸ å¢å¼ºç‰ˆå¿«ç…§åˆ›å»ºæˆåŠŸ\næ–‡ä»¶: $(basename $SNAPSHOT_FILE)\nå¤§å°: $size_human\nè€—æ—¶: ${duration}ç§’\næ¨¡å¼: $BACKUP_MODE"
    
    return 0
}

# è¿œç¨‹ç©ºé—´æ£€æŸ¥
remote_free_bytes() {
    local path="$1"
    ssh_cmd "$TARGET_USER@$TARGET_IP" "df -P \"$path\" | awk 'NR==2{print \$4*1024}'" 2>/dev/null | tr -d '\r'
}

# è¿œç¨‹ç›®å½•åˆ›å»º
remote_mkdir() {
    local dir="$1"
    ssh_cmd "$TARGET_USER@$TARGET_IP" "mkdir -p \"$dir\"" >/dev/null 2>&1
}

# æ™ºèƒ½è·¯å¾„é€‰æ‹©
select_optimal_remote_path() {
    local candidates=("/mnt/wd/Remote_backup" "$TARGET_BASE_DIR")
    local snapshot_size=$(stat -c%s "$SNAPSHOT_FILE" 2>/dev/null || echo 0)
    local required_space=$((snapshot_size + 500*1024*1024))  # é¢å¤–500MBç¼“å†²
    
    for base_dir in "${candidates[@]}"; do
        remote_mkdir "$base_dir"
        local free_space=$(remote_free_bytes "$base_dir")
        
        if [ -n "$free_space" ] && [ "$free_space" -ge "$required_space" ]; then
            echo "$base_dir"
            return 0
        fi
    done
    
    # å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œè¿”å›é»˜è®¤è·¯å¾„
    echo "$TARGET_BASE_DIR"
}

# é«˜çº§ä¸Šä¼ åŠŸèƒ½
upload_enhanced_snapshot() {
    local snapshot_size=$(stat -c%s "$SNAPSHOT_FILE" 2>/dev/null || echo 0)
    local snapshot_human=$(format_bytes $snapshot_size)
    local snapshot_name=$(basename "$SNAPSHOT_FILE")
    
    # é€‰æ‹©æœ€ä½³è¿œç¨‹è·¯å¾„
    local optimal_base=$(select_optimal_remote_path)
    local full_remote_path="$optimal_base/$REMOTE_DIR_NAME"
    
    send_tg "â¬†ï¸ å¼€å§‹æ™ºèƒ½ä¸Šä¼ \næœåŠ¡å™¨: $TARGET_USER@$TARGET_IP:$SSH_PORT\nè·¯å¾„: $full_remote_path\næ–‡ä»¶: $snapshot_name\nå¤§å°: $snapshot_human"
    
    log_info "å¼€å§‹ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨..."
    
    # SSHè¿æ¥æµ‹è¯•
    if ! retry_command "ssh_cmd '$TARGET_USER@$TARGET_IP' 'echo test' >/dev/null"; then
        log_error "æ— æ³•è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨"
        send_tg "âŒ ä¸Šä¼ å¤±è´¥\nåŸå› : æ— æ³•è¿æ¥ $TARGET_USER@$TARGET_IP:$SSH_PORT"
        return 1
    fi
    
    # åˆ›å»ºè¿œç¨‹ç›®å½•ç»“æ„
    remote_mkdir "$full_remote_path/system_snapshots"
    remote_mkdir "$full_remote_path/metadata"
    remote_mkdir "$full_remote_path/checksums"
    
    # ç©ºé—´æ£€æŸ¥
    local free_space=$(remote_free_bytes "$optimal_base")
    local required_space=$((snapshot_size + 500*1024*1024))
    
    if [ -n "$free_space" ] && [ "$free_space" -lt "$required_space" ]; then
        log_error "è¿œç¨‹ç©ºé—´ä¸è¶³: éœ€è¦$(format_bytes $required_space), å¯ç”¨$(format_bytes $free_space)"
        send_tg "âŒ ç©ºé—´ä¸è¶³\néœ€è¦: $(format_bytes $required_space)\nå¯ç”¨: $(format_bytes $free_space)\nè·¯å¾„: $optimal_base"
        return 1
    fi
    
    # å¼€å§‹ä¸Šä¼ 
    local start_time=$(date +%s)
    local upload_method=""
    local upload_success=0
    
    # å°è¯• rsyncï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
    if ssh_cmd "$TARGET_USER@$TARGET_IP" "command -v rsync >/dev/null 2>&1" && command -v rsync >/dev/null 2>&1; then
        log_info "ä½¿ç”¨ rsync ä¸Šä¼ ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰..."
        if retry_command "rsync -avz --partial --progress --timeout=600 \
                         -e 'ssh -i $SSH_KEY -p $SSH_PORT $SSH_OPTS' \
                         '$SNAPSHOT_FILE' \
                         '$TARGET_USER@$TARGET_IP:$full_remote_path/system_snapshots/'"; then
            upload_success=1
            upload_method="rsync"
        fi
    fi
    
    # rsync å¤±è´¥æ—¶ä½¿ç”¨ scp
    if [ "$upload_success" -eq 0 ]; then
        log_info "rsync ä¸å¯ç”¨æˆ–å¤±è´¥ï¼Œä½¿ç”¨ scp..."
        if retry_command "scp -i '$SSH_KEY' -P '$SSH_PORT' -o IdentitiesOnly=yes \
                         '$SNAPSHOT_FILE' \
                         '$TARGET_USER@$TARGET_IP:$full_remote_path/system_snapshots/'"; then
            upload_success=1
            upload_method="scp"
        fi
    fi
    
    if [ "$upload_success" -eq 0 ]; then
        send_tg "âŒ ä¸Šä¼ å¤±è´¥\næ–‡ä»¶: $snapshot_name\næ‰€æœ‰æ–¹æ³•å‡å¤±è´¥"
        return 1
    fi
    
    # ä¸Šä¼ å…ƒæ•°æ®
    log_info "ä¸Šä¼ å…ƒæ•°æ®..."
    if [ -d "$METADATA_DIR" ]; then
        retry_command "rsync -avz --timeout=300 \
                      -e 'ssh -i $SSH_KEY -p $SSH_PORT $SSH_OPTS' \
                      '$METADATA_DIR/' \
                      '$TARGET_USER@$TARGET_IP:$full_remote_path/metadata/'" || \
        retry_command "scp -r -i '$SSH_KEY' -P '$SSH_PORT' -o IdentitiesOnly=yes \
                      '$METADATA_DIR/' \
                      '$TARGET_USER@$TARGET_IP:$full_remote_path/metadata/'" || true
    fi
    
    # ä¸Šä¼ æ ¡éªŒå’Œ
    if [[ "$ENABLE_VERIFICATION" == "Y" ]] && [ -f "${SNAPSHOT_FILE}.sha256" ]; then
        log_info "ä¸Šä¼ æ ¡éªŒå’Œ..."
        retry_command "scp -i '$SSH_KEY' -P '$SSH_PORT' -o IdentitiesOnly=yes \
                      '${SNAPSHOT_FILE}.sha256' \
                      '$TARGET_USER@$TARGET_IP:$full_remote_path/checksums/'" || true
    fi
    
    # è®¡ç®—ä¼ è¾“ç»Ÿè®¡
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local speed="N/A"
    
    if [ "$duration" -gt 0 ]; then
        local speed_bps=$((snapshot_size / duration))
        speed="$(format_bytes $speed_bps)/s"
    fi
    
    log_info "ä¸Šä¼ å®Œæˆ - æ–¹æ³•: $upload_method, è€—æ—¶: ${duration}ç§’, é€Ÿåº¦: $speed"
    send_tg "âœ… ä¸Šä¼ æˆåŠŸ\næ–¹æ³•: $upload_method\nè€—æ—¶: ${duration}ç§’\nå¹³å‡é€Ÿåº¦: $speed\nç›®æ ‡: $full_remote_path"
    
    # è¿œç¨‹æ¸…ç†
    log_info "æ‰§è¡Œè¿œç¨‹æ¸…ç†..."
    ssh_cmd "$TARGET_USER@$TARGET_IP" \
        "find '$full_remote_path/system_snapshots' -type f -name '*.tar*' -mtime +$REMOTE_SNAPSHOT_DAYS -delete" 2>/dev/null || \
    ssh_cmd "$TARGET_USER@$TARGET_IP" \
        "find '$full_remote_path/system_snapshots' -type f -name '*.tar*' -mtime +$REMOTE_SNAPSHOT_DAYS -exec rm -f {} \;" || true
    
    send_tg "ğŸ§¹ è¿œç¨‹æ¸…ç†å®Œæˆ\nä¿ç•™: ${REMOTE_SNAPSHOT_DAYS}å¤©\nç›®å½•: $full_remote_path/system_snapshots"
    
    return 0
}

# æœ¬åœ°æ¸…ç†
cleanup_local_snapshots() {
    log_info "æ¸…ç†æœ¬åœ°æ—§å¿«ç…§..."
    
    # æ¸…ç†å¿«ç…§æ–‡ä»¶
    local snapshots=($(find "$BACKUP_DIR" -maxdepth 1 -type f -name "system_snapshot_*.tar*" | sort -r))
    local total_snapshots=${#snapshots[@]}
    
    if [ "$total_snapshots" -gt "$LOCAL_SNAPSHOT_KEEP" ]; then
        local to_remove=$((total_snapshots - LOCAL_SNAPSHOT_KEEP))
        log_info "éœ€è¦åˆ é™¤ $to_remove ä¸ªæ—§å¿«ç…§"
        
        for ((i=LOCAL_SNAPSHOT_KEEP; i<total_snapshots; i++)); do
            local old_snapshot="${snapshots[$i]}"
            log_info "åˆ é™¤æ—§å¿«ç…§: $(basename $old_snapshot)"
            rm -f "$old_snapshot"
            rm -f "${old_snapshot}.sha256"  # åŒæ—¶åˆ é™¤æ ¡éªŒå’Œæ–‡ä»¶
        done
    fi
    
    # æ¸…ç†æ—§çš„å…ƒæ•°æ®
    find "$BACKUP_DIR/metadata" -type f -mtime +$((LOCAL_SNAPSHOT_KEEP * 2)) -delete 2>/dev/null || true
    
    log_info "æœ¬åœ°æ¸…ç†å®Œæˆ"
}

# å¤‡ä»½å®Œæ•´æ€§éªŒè¯
verify_backup_integrity() {
    if [[ "$ENABLE_VERIFICATION" != "Y" ]]; then
        return 0
    fi
    
    log_info "éªŒè¯å¤‡ä»½å®Œæ•´æ€§..."
    local checksum_file="${SNAPSHOT_FILE}.sha256"
    
    if [ ! -f "$checksum_file" ]; then
        log_error "æ ¡éªŒå’Œæ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
    
    if sha256sum -c "$checksum_file" >/dev/null 2>&1; then
        log_info "å¤‡ä»½å®Œæ•´æ€§éªŒè¯é€šè¿‡"
        return 0
    else
        log_error "å¤‡ä»½å®Œæ•´æ€§éªŒè¯å¤±è´¥"
        send_tg "âŒ å¤‡ä»½å®Œæ•´æ€§éªŒè¯å¤±è´¥\næ–‡ä»¶: $(basename $SNAPSHOT_FILE)\næ—¶é—´: $(date '+%F %T')"
        return 1
    fi
}

# è®¾ç½®ç³»ç»Ÿå®šæ—¶ä»»åŠ¡
setup_systemd_timer() {
    local service_file="/etc/systemd/system/system-snapshot.service"
    local timer_file="/etc/systemd/system/system-snapshot.timer"
    
    # åœæ­¢ç°æœ‰å®šæ—¶å™¨
    systemctl stop system-snapshot.timer 2>/dev/null || true
    
    # åˆ›å»º systemd service
    cat > "$service_file" << EOF
[Unit]
Description=Enhanced System Snapshot Backup Service
After=network.target network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=$(realpath "$0")
Environment="SYSTEMD_TIMER=1"
WorkingDirectory=/root
User=root
Group=root

# èµ„æºé™åˆ¶
CPUQuota=50%
MemoryMax=2G
IOWeight=100

# é”™è¯¯å¤„ç†
Restart=no
TimeoutStartSec=3600

[Install]
WantedBy=multi-user.target
EOF

    # åˆ›å»º systemd timer
    cat > "$timer_file" << EOF
[Unit]
Description=Run Enhanced System Snapshot Every $BACKUP_INTERVAL_DAYS Days
Requires=system-snapshot.service

[Timer]
OnActiveSec=2h
OnUnitActiveSec=${BACKUP_INTERVAL_DAYS}d
RandomizedDelaySec=1h
Persistent=true

[Install]
WantedBy=timers.target
EOF

    # é‡æ–°åŠ è½½å¹¶å¯ç”¨
    systemctl daemon-reload
    systemctl enable system-snapshot.timer
    systemctl start system-snapshot.timer
    
    local next_run=$(systemctl list-timers system-snapshot.timer --no-pager | awk 'NR==2 {print $1" "$2}')
    log_info "å®šæ—¶å™¨å·²é…ç½®: ${BACKUP_INTERVAL_DAYS}å¤©é—´éš”"
    log_info "ä¸‹æ¬¡è¿è¡Œ: $next_run"
    
    send_tg "â° å®šæ—¶ä»»åŠ¡å·²æ›´æ–°\né—´éš”: ${BACKUP_INTERVAL_DAYS}å¤©\nä¸‹æ¬¡è¿è¡Œ: $next_run\nä¸»æœº: $(hostname)"
}

# ä¸»æ‰§è¡Œå‡½æ•°
main_backup_process() {
    log_info "========== SnapSync v2.5 å¢å¼ºç‰ˆå¤‡ä»½å¼€å§‹ =========="
    log_info "ä¸»æœº: $(hostname), æ¨¡å¼: $BACKUP_MODE, æ—¶é—´: $(date '+%F %T')"
    
    # åˆ›å»ºå¢å¼ºç‰ˆå¿«ç…§
    if ! create_enhanced_snapshot; then
        log_error "å¿«ç…§åˆ›å»ºå¤±è´¥"
        return 1
    fi
    
    # éªŒè¯å¤‡ä»½å®Œæ•´æ€§
    if ! verify_backup_integrity; then
        log_error "å¤‡ä»½éªŒè¯å¤±è´¥"
        return 1
    fi
    
    # æ¸…ç†æœ¬åœ°æ—§å¿«ç…§
    cleanup_local_snapshots
    
    # ä¸Šä¼ åˆ°è¿œç¨‹
    if ! upload_enhanced_snapshot; then
        log_error "è¿œç¨‹ä¸Šä¼ å¤±è´¥"
        # ä¸è¿”å›é”™è¯¯ï¼Œå…è®¸åªæœ¬åœ°å¤‡ä»½
    fi
    
    # ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
    generate_backup_report
    
    log_info "========== SnapSync v2.5 å¢å¼ºç‰ˆå¤‡ä»½å®Œæˆ =========="
    return 0
}

# ç”Ÿæˆå¤‡ä»½æŠ¥å‘Š
generate_backup_report() {
    local total_snapshots=$(find "$BACKUP_DIR" -maxdepth 1 -type f -name "system_snapshot_*.tar*" | wc -l)
    local total_size_bytes=$(find "$BACKUP_DIR" -maxdepth 1 -type f -name "system_snapshot_*.tar*" -exec stat -c%s {} + 2>/dev/null | awk '{s+=$1} END{print s+0}')
    local total_size_human=$(format_bytes $total_size_bytes)
    
    local current_size=$(stat -c%s "$SNAPSHOT_FILE" 2>/dev/null || echo 0)
    local current_size_human=$(format_bytes $current_size)
    
    log_info "å¤‡ä»½æŠ¥å‘Š:"
    log_info "- æœ¬æ¬¡å¿«ç…§: $(basename $SNAPSHOT_FILE) ($current_size_human)"
    log_info "- æœ¬åœ°å¿«ç…§æ€»æ•°: $total_snapshots ä¸ª"
    log_info "- æœ¬åœ°æ€»å¤§å°: $total_size_human"
    log_info "- å¤‡ä»½æ¨¡å¼: $BACKUP_MODE"
    log_info "- å‹ç¼©: $ENABLE_COMPRESSION"
    log_info "- éªŒè¯: $ENABLE_VERIFICATION"
    
    send_tg "ğŸ“Š å¤‡ä»½æŠ¥å‘Š | $(hostname)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ æœ¬æ¬¡: $(basename $SNAPSHOT_FILE)\nğŸ“ å¤§å°: $current_size_human\nğŸ—‚ï¸ æ€»æ•°: $total_snapshots ä¸ª\nğŸ’¾ æ€»è®¡: $total_size_human\nğŸ”§ æ¨¡å¼: $BACKUP_MODE\nâ° æ—¶é—´: $(date '+%F %T')"
}

# ç¨‹åºå…¥å£
if [ -z "$SYSTEMD_TIMER" ]; then
    setup_systemd_timer
fi

main_backup_process
exit $?
SCRIPT_EOF

    chmod +x "$SCRIPT_FILE"
    chmod 600 "$CONFIG_FILE"
    log "${GREEN}âœ“ å¢å¼ºç‰ˆå¤‡ä»½è„šæœ¬åˆ›å»ºå®Œæˆï¼${NC}\n"
}

# ä¸»å‡½æ•°
main() {
    clear
    show_title "SnapSync v2.5 å¢å¼ºç‰ˆå®‰è£…å‘å¯¼"
    log "${GREEN}ğŸš€ å…¨ç›˜æ— æŸå¤‡ä»½ä¸æ¢å¤å·¥å…·${NC}"
    log "${CYAN}æ–°ç‰¹æ€§: å®Œæ•´æƒé™ä¿ç•™ã€ACLã€æ‰©å±•å±æ€§ã€å¢é‡å¤‡ä»½ã€å®Œæ•´æ€§éªŒè¯${NC}\n"
    
    check_requirements
    collect_config
    setup_ssh_key
    test_telegram
    create_enhanced_script
    
    if [[ "$RUN_NOW" =~ ^[Yy]$ ]]; then
        log "${YELLOW}æ­£åœ¨æ‰§è¡Œé¦–æ¬¡æµ‹è¯•å¤‡ä»½...${NC}"
        bash "$SCRIPT_FILE"
    fi
    
    show_title "å®‰è£…å®Œæˆ"
    log "${GREEN}âœ… SnapSync v2.5 å¢å¼ºç‰ˆå®‰è£…æˆåŠŸï¼${NC}\n"
    
    log "${CYAN}é‡è¦æ–‡ä»¶ä½ç½®:${NC}"
    log "  é…ç½®æ–‡ä»¶: $CONFIG_FILE"
    log "  å¤‡ä»½è„šæœ¬: $SCRIPT_FILE"
    log "  æ—¥å¿—ç›®å½•: $LOG_DIR\n"
    
    log "${CYAN}ç®¡ç†å‘½ä»¤:${NC}"
    log "  æŸ¥çœ‹çŠ¶æ€: ${YELLOW}systemctl status system-snapshot.timer${NC}"
    log "  ç«‹å³æ‰§è¡Œ: ${YELLOW}systemctl start system-snapshot.service${NC}"
    log "  æŸ¥çœ‹æ—¥å¿—: ${YELLOW}tail -f $SNAPSHOT_LOG_FILE${NC}"
    log "  åœç”¨å®šæ—¶: ${YELLOW}systemctl disable system-snapshot.timer${NC}\n"
    
    log "${CYAN}å¢å¼ºç‰¹æ€§:${NC}"
    log "  âœ“ å®Œæ•´æ–‡ä»¶æƒé™å’Œå±æ€§ä¿ç•™"
    log "  âœ“ ACL å’Œæ‰©å±•å±æ€§æ”¯æŒ"
    log "  âœ“ å¢é‡å¤‡ä»½æ”¯æŒ"
    log "  âœ“ å¤šçº¿ç¨‹å‹ç¼©"
    log "  âœ“ å®Œæ•´æ€§éªŒè¯"
    log "  âœ“ æ™ºèƒ½èµ„æºç®¡ç†"
    log "  âœ“ æ–­ç‚¹ç»­ä¼ æ”¯æŒ\n"
    
    log "${YELLOW}æç¤º: å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ¢å¤åŠŸèƒ½åå†ç”¨äºç”Ÿäº§ç¯å¢ƒ${NC}"
}

main "$@"
