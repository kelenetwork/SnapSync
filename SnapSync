#!/bin/bash

# ç²¾ç®€å¢å¼ºç‰ˆäº¤äº’å¼ç³»ç»Ÿå¿«ç…§å¤‡ä»½å·¥å…·å®‰è£…è„šæœ¬
# ç‰ˆæœ¬: v2.1-optimized - ä¿®æ”¹å®šæ—¶å™¨é…ç½®å’ŒTGé€šçŸ¥é€»è¾‘

# ====================================================================
# ## USER CONFIGURATION ##
# åœ¨è¿è¡Œè„šæœ¬å‰ï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨æ­¤å¤„ä¿®æ”¹é»˜è®¤å€¼ï¼Œä»¥å®ç°å¿«é€Ÿéƒ¨ç½²
# ====================================================================

# --- Telegram é…ç½® ---
BOT_TOKEN=""
CHAT_ID=""

# --- è¿œç¨‹ SSH æœåŠ¡å™¨é…ç½® ---
TARGET_IP=""
TARGET_USER="root"
SSH_PORT=""
TARGET_BASE_DIR="/root/Remote_backup"
REMOTE_DIR_NAME=""

# --- æœ¬åœ°é…ç½® ---
BACKUP_DIR="/backups"

# --- å¤‡ä»½ä¿ç•™ç­–ç•¥ ---
LOCAL_SNAPSHOT_KEEP="2"
REMOTE_SNAPSHOT_DAYS="15"

# --- è‡ªåŠ¨åŒ–é…ç½® ---
BACKUP_INTERVAL_DAYS="5"
RUN_NOW="Y"

# --- æ–°å¢é…ç½® ---
DISK_SPACE_THRESHOLD="85"  # ç£ç›˜ä½¿ç”¨ç‡é˜ˆå€¼(%)
MAX_RETRY_ATTEMPTS="3"     # ç½‘ç»œæ“ä½œæœ€å¤§é‡è¯•æ¬¡æ•°
LOAD_THRESHOLD_MULTIPLIER="1.0"  # è´Ÿè½½é˜ˆå€¼å€æ•°(åŸºäºCPUæ ¸å¿ƒæ•°)ï¼Œ1.0è¡¨ç¤ºç­‰äºæ ¸å¿ƒæ•°
MEMORY_THRESHOLD="80"      # å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼(%)ï¼Œè¶…è¿‡æ­¤å€¼ä¼šåœ¨TGä¸­æé†’

# ====================================================================
# è„šæœ¬æ ¸å¿ƒä»£ç 
# ====================================================================

# é¢œè‰²è®¾ç½®
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ ‡å‡†åŒ–è·¯å¾„å®šä¹‰
CONFIG_DIR="/etc/system_snapshot"
CONFIG_FILE="$CONFIG_DIR/config.conf"
SCRIPT_DIR="/usr/local/sbin"
SCRIPT_FILE="$SCRIPT_DIR/system_snapshot.sh"
LOG_DIR="/var/log/system_snapshot"
INSTALL_LOG_FILE="$LOG_DIR/install.log"
SNAPSHOT_LOG_FILE="$LOG_DIR/snapshot.log"
DEBUG_LOG_FILE="$LOG_DIR/debug.log"

# æ—¥å¿—å‡½æ•°
log() {
    mkdir -p "$LOG_DIR"
    echo -e "$1" | tee -a "$INSTALL_LOG_FILE"
}

# é”™è¯¯å¤„ç†å‡½æ•°
error_exit() {
    log "${RED}é”™è¯¯: $1${NC}"
    exit 1
}

# æ˜¾ç¤ºå¸¦è¾¹æ¡†çš„æ ‡é¢˜
show_title() {
    local title="$1"
    local width=60
    local padding=$(( (width - ${#title}) / 2 ))
    echo -e "\n${BLUE}$(printf '=%.0s' {1..60})${NC}"
    echo -e "${BLUE}$(printf ' %.0s' {1..$padding})${CYAN}$title${BLUE}$(printf ' %.0s' {1..$padding})${NC}"
    echo -e "${BLUE}$(printf '=%.0s' {1..60})${NC}\n"
}

# éªŒè¯å¿…è¦æ¡ä»¶
check_requirements() {
    if [ "$EUID" -ne 0 ]; then
        error_exit "è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
    fi
    for cmd in curl ssh rsync tar git hostname jq bc; do
        if ! command -v $cmd &> /dev/null; then
            log "${YELLOW}å®‰è£… $cmd...${NC}"
            apt-get update && apt-get install -y $cmd || error_exit "æ— æ³•å®‰è£… $cmd"
        fi
    done
    # å°è¯•å®‰è£…pigzç”¨äºå¤šçº¿ç¨‹å‹ç¼©
    if ! command -v pigz &> /dev/null; then
        apt-get install -y pigz 2>/dev/null || log "${YELLOW}pigz å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨ gzip${NC}"
    fi
}

# ç®€åŒ–çš„é…ç½®éªŒè¯
validate_config() {
    for param in BOT_TOKEN CHAT_ID TARGET_IP; do
        if [ -z "${!param}" ]; then
            error_exit "é…ç½®å‚æ•° $param ä¸èƒ½ä¸ºç©º"
        fi
    done
    if ! [[ "$SSH_PORT" =~ ^[0-9]+$ ]] || [ "$SSH_PORT" -lt 1 ] || [ "$SSH_PORT" -gt 65535 ]; then
        error_exit "SSHç«¯å£æ— æ•ˆ: $SSH_PORT"
    fi
}

# é…ç½®æ”¶é›†å‡½æ•°ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼Œç§»é™¤å†—ä½™è¾“å‡ºï¼‰
collect_config() {
    show_title "ç³»ç»Ÿå¿«ç…§å¤‡ä»½é…ç½®å‘å¯¼"
    log "${CYAN}â„¹ï¸ å°†åŠ è½½è„šæœ¬é¡¶éƒ¨çš„é¢„è®¾å€¼ä½œä¸ºé»˜è®¤é¡¹ï¼Œå¯ç›´æ¥å›è½¦ä½¿ç”¨ã€‚${NC}\n"

    # Telegramé…ç½®
    log "${YELLOW}ğŸ“± Telegram é€šçŸ¥é…ç½®:${NC}"
    read -p "è¯·è¾“å…¥ Telegram Bot Token [å½“å‰: ${BOT_TOKEN:0:8}...]: " INPUT
    BOT_TOKEN=${INPUT:-$BOT_TOKEN}
    while [ -z "$BOT_TOKEN" ]; do
        log "${RED}Bot Token ä¸èƒ½ä¸ºç©º${NC}"
        read -p "è¯·è¾“å…¥ Telegram Bot Token: " BOT_TOKEN
    done

    read -p "è¯·è¾“å…¥ Telegram Chat ID [å½“å‰: $CHAT_ID]: " INPUT
    CHAT_ID=${INPUT:-$CHAT_ID}
    while [ -z "$CHAT_ID" ]; do
        log "${RED}Chat ID ä¸èƒ½ä¸ºç©º${NC}"
        read -p "è¯·è¾“å…¥ Telegram Chat ID: " CHAT_ID
    done
    echo

    # è¿œç¨‹æœåŠ¡å™¨é…ç½®
    log "${YELLOW}ğŸŒ è¿œç¨‹æœåŠ¡å™¨é…ç½®:${NC}"
    read -p "è¯·è¾“å…¥è¿œç¨‹æœåŠ¡å™¨IPåœ°å€ [å½“å‰: $TARGET_IP]: " INPUT
    TARGET_IP=${INPUT:-$TARGET_IP}
    while [ -z "$TARGET_IP" ]; do
        log "${RED}IPåœ°å€ä¸èƒ½ä¸ºç©º${NC}"
        read -p "è¯·è¾“å…¥è¿œç¨‹æœåŠ¡å™¨IPåœ°å€: " TARGET_IP
    done

    read -p "è¯·è¾“å…¥è¿œç¨‹æœåŠ¡å™¨ç”¨æˆ·å [é»˜è®¤: $TARGET_USER]: " INPUT
    TARGET_USER=${INPUT:-$TARGET_USER}

    read -p "è¯·è¾“å…¥SSHç«¯å£ [é»˜è®¤: $SSH_PORT]: " INPUT
    SSH_PORT=${INPUT:-$SSH_PORT}
    echo

    # è¿œç¨‹ç›®å½•é…ç½®
    log "${YELLOW}ğŸ“ è¿œç¨‹å­˜å‚¨é…ç½®:${NC}"
    read -p "è¯·è¾“å…¥è¿œç¨‹åŸºç¡€å¤‡ä»½ç›®å½• [é»˜è®¤: $TARGET_BASE_DIR]: " INPUT
    TARGET_BASE_DIR=${INPUT:-$TARGET_BASE_DIR}

    HOSTNAME=$(hostname)
    if [ -z "$REMOTE_DIR_NAME" ]; then
        REMOTE_DIR_NAME="$HOSTNAME"
        log "\n${CYAN}â„¹ï¸ æœ¬æœºå°†åœ¨è¿œç¨‹åˆ›å»ºç›®å½•: $TARGET_BASE_DIR/$REMOTE_DIR_NAME${NC}"
        read -p "æ˜¯å¦ä½¿ç”¨æ­¤é»˜è®¤ç›®å½•å '$REMOTE_DIR_NAME'? [Y/n]: " USE_DEFAULT_HOSTNAME
        if [[ "$USE_DEFAULT_HOSTNAME" =~ ^[Nn]$ ]]; then
            read -p "è¯·è¾“å…¥è‡ªå®šä¹‰ç›®å½•å: " CUSTOM_HOSTNAME
            while [ -z "$CUSTOM_HOSTNAME" ]; do
                log "${RED}ç›®å½•åä¸èƒ½ä¸ºç©º${NC}"
                read -p "è¯·è¾“å…¥è‡ªå®šä¹‰ç›®å½•å: " CUSTOM_HOSTNAME
            done
            REMOTE_DIR_NAME="$CUSTOM_HOSTNAME"
        fi
    else
        log "\n${CYAN}â„¹ï¸ ä½¿ç”¨é¢„è®¾çš„è¿œç¨‹ç›®å½•å: $REMOTE_DIR_NAME${NC}"
    fi

    FULL_REMOTE_PATH="$TARGET_BASE_DIR/$REMOTE_DIR_NAME"
    log "${GREEN}âœ“ è¿œç¨‹å®Œæ•´è·¯å¾„: $FULL_REMOTE_PATH${NC}"
    echo

    # æœ¬åœ°é…ç½®
    log "${YELLOW}ğŸ’¾ æœ¬åœ°é…ç½®:${NC}"
    read -p "è¯·è¾“å…¥æœ¬åœ°å¤‡ä»½ç›®å½• [é»˜è®¤: $BACKUP_DIR]: " INPUT
    BACKUP_DIR=${INPUT:-$BACKUP_DIR}

    # ä¿ç•™ç­–ç•¥é…ç½®
    log "\n${YELLOW}ğŸ—„ï¸ å¤‡ä»½ä¿ç•™ç­–ç•¥:${NC}"
    read -p "è¯·è¾“å…¥æœ¬åœ°ä¿ç•™å¿«ç…§æ•°é‡ [é»˜è®¤: $LOCAL_SNAPSHOT_KEEP]: " INPUT
    LOCAL_SNAPSHOT_KEEP=${INPUT:-$LOCAL_SNAPSHOT_KEEP}

    read -p "è¯·è¾“å…¥è¿œç¨‹å¿«ç…§ä¿ç•™å¤©æ•° [é»˜è®¤: $REMOTE_SNAPSHOT_DAYS]: " INPUT
    REMOTE_SNAPSHOT_DAYS=${INPUT:-$REMOTE_SNAPSHOT_DAYS}
    echo

    # è‡ªåŠ¨æ‰§è¡Œé—´éš”é…ç½®
    log "${YELLOW}â° è‡ªåŠ¨æ‰§è¡Œé…ç½®:${NC}"
    read -p "è¯·è¾“å…¥å¤‡ä»½é—´éš”å¤©æ•° (1-30) [é»˜è®¤: $BACKUP_INTERVAL_DAYS]: " INPUT
    BACKUP_INTERVAL_DAYS=${INPUT:-$BACKUP_INTERVAL_DAYS}
    while [[ ! "$BACKUP_INTERVAL_DAYS" =~ ^[1-9]$|^[1-2][0-9]$|^30$ ]]; do
        log "${RED}è¯·è¾“å…¥1-30ä¹‹é—´çš„æ•°å­—${NC}"
        read -p "è¯·è¾“å…¥å¤‡ä»½é—´éš”å¤©æ•° [é»˜è®¤: 5]: " INPUT
        BACKUP_INTERVAL_DAYS=${INPUT:-5}
    done

    read -p "æ˜¯å¦éœ€è¦ç«‹å³æ‰§è¡Œä¸€æ¬¡å¿«ç…§æµ‹è¯•ï¼Ÿ[Y/n]: " INPUT
    RUN_NOW=${INPUT:-$RUN_NOW}
    echo

    # éªŒè¯é…ç½®
    validate_config

    # é…ç½®é¢„è§ˆ
    show_title "é…ç½®é¢„è§ˆ"
    log "${CYAN}è¿œç¨‹æœåŠ¡å™¨:${NC} $TARGET_USER@$TARGET_IP:$SSH_PORT"
    log "${CYAN}è¿œç¨‹è·¯å¾„:${NC} $FULL_REMOTE_PATH"
    log "${CYAN}æœ¬åœ°è·¯å¾„:${NC} $BACKUP_DIR"
    log "${CYAN}ä¿ç•™ç­–ç•¥:${NC} æœ¬åœ°${LOCAL_SNAPSHOT_KEEP}ä¸ªï¼Œè¿œç¨‹${REMOTE_SNAPSHOT_DAYS}å¤©"
    log "${CYAN}è‡ªåŠ¨æ‰§è¡Œ:${NC} æ¯${BACKUP_INTERVAL_DAYS}å¤©ä¸€æ¬¡"
    echo

    read -p "ç¡®è®¤ä»¥ä¸Šé…ç½®å¹¶ç»§ç»­ï¼Ÿ[Y/n]: " CONFIRM_CONFIG
    if [[ "$CONFIRM_CONFIG" =~ ^[Nn]$ ]]; then
        log "\n${YELLOW}é…ç½®å·²å–æ¶ˆï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬è¿›è¡Œé…ç½®${NC}"
        exit 0
    fi
}

# SSHå¯†é’¥é…ç½®
setup_ssh_key() {
    show_title "SSHå¯†é’¥é…ç½® (Ed25519)"
    
    mkdir -p /root/.ssh
    chmod 700 /root/.ssh
    
    if [ ! -f "/root/.ssh/id_ed25519" ]; then
        log "${YELLOW}ç”Ÿæˆæ–°çš„ Ed25519 SSH å¯†é’¥...${NC}"
        ssh-keygen -t ed25519 -N "" -f /root/.ssh/id_ed25519 -q
    fi
    
    log "${YELLOW}è¯·å°†ä»¥ä¸‹å…¬é’¥æ·»åŠ åˆ°è¿œç¨‹æœåŠ¡å™¨çš„ ~/.ssh/authorized_keys æ–‡ä»¶ä¸­:${NC}"
    echo -e "\n${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    cat /root/.ssh/id_ed25519.pub
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
    
    read -p "å·²å°†å…¬é’¥æ·»åŠ åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Ÿç»§ç»­æµ‹è¯•è¿æ¥... [Y/n]: " SSH_OK
    if [[ ! "$SSH_OK" =~ ^[Nn]$ ]]; then
        log "${YELLOW}æµ‹è¯•SSHè¿æ¥...${NC}"
        if ssh -p "$SSH_PORT" -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/root/.ssh/known_hosts "$TARGET_USER@$TARGET_IP" "echo 'SSHè¿æ¥æµ‹è¯•æˆåŠŸ'" 2>/dev/null; then
            log "${GREEN}âœ“ SSHè¿æ¥æµ‹è¯•æˆåŠŸï¼${NC}\n"
            
            log "${YELLOW}åˆ›å»ºè¿œç¨‹ç›®å½•ç»“æ„...${NC}"
            ssh -p "$SSH_PORT" "$TARGET_USER@$TARGET_IP" "mkdir -p $FULL_REMOTE_PATH/system_snapshots $FULL_REMOTE_PATH/configs $FULL_REMOTE_PATH/logs" 2>/dev/null
            
            if [ $? -eq 0 ]; then
                log "${GREEN}âœ“ è¿œç¨‹ç›®å½•åˆ›å»ºæˆåŠŸ: $FULL_REMOTE_PATH${NC}\n"
            else
                log "${YELLOW}âš  è¿œç¨‹ç›®å½•åˆ›å»ºå¯èƒ½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥${NC}\n"
            fi
        else
            log "${RED}âœ— SSHè¿æ¥å¤±è´¥ã€‚è¯·æ£€æŸ¥é…ç½®åé‡è¯•ã€‚${NC}"
            read -p "ç»§ç»­å®‰è£…ï¼ˆå°†è·³è¿‡è¿œç¨‹å¤‡ä»½ï¼‰ï¼Ÿ[y/N]: " CONTINUE
            if [[ ! "$CONTINUE" =~ ^[Yy]$ ]]; then
                exit 1
            fi
        fi
    fi
}

# æµ‹è¯•Telegramé€šçŸ¥
test_telegram() {
    show_title "Telegramé€šçŸ¥æµ‹è¯•"
    response=$(curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" \
        -d text="ğŸš€ *ç³»ç»Ÿå¿«ç…§å¤‡ä»½å·¥å…·å®‰è£…æµ‹è¯•*

- æ‚¨æ­£åœ¨ä½¿ç”¨ç³»ç»Ÿå¿«ç…§å¤‡ä»½å·¥å…·
- æ—¶é—´: \`$(date '+%F %T')\`
- ä¸»æœº: \`$(hostname)\`" \
        -d parse_mode="Markdown")
    if [[ $response == *"\"ok\":true"* ]]; then
        log "${GREEN}âœ“ Telegramé€šçŸ¥æµ‹è¯•æˆåŠŸï¼${NC}\n"
    else
        log "${RED}âœ— Telegramé€šçŸ¥å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®${NC}\n"
    fi
}

# åˆ›å»ºé…ç½®æ–‡ä»¶å’Œä¸»è„šæœ¬
create_script() {
    show_title "åˆ›å»ºå¤‡ä»½è„šæœ¬"
    
    mkdir -p "$BACKUP_DIR" "$CONFIG_DIR" "$SCRIPT_DIR" "$LOG_DIR"
    
    log "${YELLOW}åˆ›å»ºé…ç½®æ–‡ä»¶...${NC}"
    cat > "$CONFIG_FILE" << EOF
#!/bin/bash
# ç³»ç»Ÿå¿«ç…§å¤‡ä»½é…ç½®æ–‡ä»¶ (ç”±å®‰è£…è„šæœ¬è‡ªåŠ¨ç”Ÿæˆäº: $(date '+%F %T'))

# Telegramé…ç½®
BOT_TOKEN="$BOT_TOKEN"
CHAT_ID="$CHAT_ID"

# è¿œç¨‹æœåŠ¡å™¨é…ç½®
TARGET_IP="$TARGET_IP"
TARGET_USER="$TARGET_USER"
SSH_PORT="$SSH_PORT"
TARGET_BASE_DIR="$TARGET_BASE_DIR"
REMOTE_DIR_NAME="$REMOTE_DIR_NAME"

# æœ¬åœ°é…ç½®
BACKUP_DIR="$BACKUP_DIR"
HOSTNAME=\$(hostname)

# ä¿ç•™ç­–ç•¥
LOCAL_SNAPSHOT_KEEP=$LOCAL_SNAPSHOT_KEEP
REMOTE_SNAPSHOT_DAYS=$REMOTE_SNAPSHOT_DAYS

# æ‰§è¡Œé…ç½®
BACKUP_INTERVAL_DAYS=$BACKUP_INTERVAL_DAYS

# é«˜çº§é…ç½®
DISK_SPACE_THRESHOLD="$DISK_SPACE_THRESHOLD"
MAX_RETRY_ATTEMPTS="$MAX_RETRY_ATTEMPTS"
LOAD_THRESHOLD_MULTIPLIER="$LOAD_THRESHOLD_MULTIPLIER"
MEMORY_THRESHOLD="$MEMORY_THRESHOLD"

# æ—¥å¿—æ–‡ä»¶
LOG_FILE="$SNAPSHOT_LOG_FILE"
DEBUG_LOG="$DEBUG_LOG_FILE"
EOF

    log "${YELLOW}åˆ›å»ºä¸»å¤‡ä»½è„šæœ¬...${NC}"
    cat > "$SCRIPT_FILE" << 'EOF'
#!/bin/bash

# åŠ è½½é…ç½®
source "/etc/system_snapshot/config.conf" || { echo "é…ç½®æ–‡ä»¶æœªæ‰¾åˆ°"; exit 1; }

# å˜é‡è®¾ç½®
TIMESTAMP=$(date +"%Y%m%d%H%M%S")
SNAPSHOT_FILE="$BACKUP_DIR/system_snapshot_${TIMESTAMP}.tar.gz"
FULL_REMOTE_PATH="$TARGET_BASE_DIR/$REMOTE_DIR_NAME"
LOCK_FILE="/tmp/system_snapshot.lock"

# è¿›ç¨‹é” (ä½¿ç”¨flocké¿å…ç«äº‰æ¡ä»¶)
exec 200>"$LOCK_FILE"
if ! flock -n 200; then
    echo "è„šæœ¬å·²åœ¨è¿è¡Œ"
    exit 1
fi
echo $$ >&200
trap 'flock -u 200' EXIT

# æ—¥å¿—å‡½æ•°
log_info() { echo "$(date '+%F %T') [INFO] $1" | tee -a "$LOG_FILE"; }
log_error() { echo "$(date '+%F %T') [ERROR] $1" | tee -a "$LOG_FILE"; }

# é‡è¯•æœºåˆ¶ (ä¿®å¤å‚æ•°ä¼ é€’é—®é¢˜)
retry_command() {
    local max_attempts="$MAX_RETRY_ATTEMPTS"
    local attempt=1
    while [ $attempt -le $max_attempts ]; do
        if eval "$*"; then return 0; fi
        log_info "å‘½ä»¤å¤±è´¥ï¼Œç¬¬ $attempt æ¬¡é‡è¯•..."
        sleep $((attempt * 3))
        ((attempt++))
    done
    return 1
}

# å­—èŠ‚æ ¼å¼åŒ– (çº¯bashå®ç°ï¼Œæ”¯æŒç§‘å­¦è®¡æ•°æ³•)
format_bytes() {
    local bytes="$1"
    
    # å¤„ç†ç©ºå€¼æˆ–éæ•°å­—
    if [ -z "$bytes" ]; then
        echo "0B"; return
    fi
    
    # å¤„ç†ç§‘å­¦è®¡æ•°æ³• (å¦‚: 6.37266e+09)
    if [[ "$bytes" =~ [eE] ]]; then
        # ä½¿ç”¨bcæˆ–awkå°†ç§‘å­¦è®¡æ•°æ³•è½¬æ¢ä¸ºæ•´æ•°
        bytes=$(echo "$bytes" | awk '{printf "%.0f", $1}' 2>/dev/null || echo "0")
    fi
    
    # ç¡®ä¿æ˜¯æ•´æ•°
    if ! [[ "$bytes" =~ ^[0-9]+$ ]] || [ "$bytes" -eq 0 ]; then
        echo "0B"; return
    fi
    
    if [ "$bytes" -ge 1073741824 ]; then
        local gb=$((bytes / 1073741824))
        local remainder=$((bytes % 1073741824))
        local decimal=$((remainder * 10 / 1073741824))
        echo "${gb}.${decimal}GB"
    elif [ "$bytes" -ge 1048576 ]; then
        local mb=$((bytes / 1048576))
        local remainder=$((bytes % 1048576))
        local decimal=$((remainder * 10 / 1048576))
        echo "${mb}.${decimal}MB"
    elif [ "$bytes" -ge 1024 ]; then
        local kb=$((bytes / 1024))
        local remainder=$((bytes % 1024))
        local decimal=$((remainder * 10 / 1024))
        echo "${kb}.${decimal}KB"
    else
        echo "${bytes}B"
    fi
}

# ç£ç›˜ç©ºé—´æ£€æŸ¥ (æ”¹è¿›è§£æå¥å£®æ€§)
check_disk_space() {
    local disk_info=$(df "$BACKUP_DIR" 2>/dev/null | tail -n 1)
    if [ -z "$disk_info" ]; then
        log_error "æ— æ³•è·å–ç£ç›˜ä¿¡æ¯"
        return 1
    fi
    
    local disk_usage=$(echo "$disk_info" | awk '{print $5}' | sed 's/%//')
    if ! [[ "$disk_usage" =~ ^[0-9]+$ ]]; then
        log_error "æ— æ³•è§£æç£ç›˜ä½¿ç”¨ç‡"
        return 1
    fi
    
    if [ "$disk_usage" -gt "$DISK_SPACE_THRESHOLD" ]; then
        log_error "ç£ç›˜ç©ºé—´ä¸è¶³: ${disk_usage}% > ${DISK_SPACE_THRESHOLD}%"
        send_telegram_notification "å¤‡ä»½å¤±è´¥" "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜ (${disk_usage}%)" "âŒ"
        return 1
    fi
}

# è·å–ç³»ç»ŸçŠ¶æ€ä¿¡æ¯
get_system_status() {
    # è·å–è´Ÿè½½ (1åˆ†é’Ÿå¹³å‡è´Ÿè½½)
    local system_load=$(uptime | awk -F'load average:' '{print $2}' | sed 's/^[ \t]*//' | cut -d',' -f1)
    
    # è·å–å†…å­˜ä½¿ç”¨ç‡
    local memory_usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}' 2>/dev/null || echo "0")
    
    # è·å–CPUæ ¸å¿ƒæ•°å¹¶è®¡ç®—åŠ¨æ€è´Ÿè½½é˜ˆå€¼
    local cpu_cores=$(nproc 2>/dev/null || echo "1")
    local load_threshold=$(echo "$cpu_cores * $LOAD_THRESHOLD_MULTIPLIER" | bc -l 2>/dev/null || echo "$cpu_cores")
    
    echo "$system_load $memory_usage $load_threshold"
}

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
should_show_system_status() {
    local load="$1"
    local memory="$2"
    local load_threshold="$3"
    
    # ä½¿ç”¨bcè¿›è¡Œæµ®ç‚¹æ•°æ¯”è¾ƒ
    local load_high=$(echo "$load > $load_threshold" | bc -l 2>/dev/null || echo "0")
    local memory_high=0
    
    if [[ "$memory" =~ ^[0-9]+$ ]] && [ "$memory" -gt "$MEMORY_THRESHOLD" ]; then
        memory_high=1
    fi
    
    if [ "$load_high" = "1" ] || [ "$memory_high" = "1" ]; then
        return 0  # éœ€è¦æ˜¾ç¤º
    else
        return 1  # ä¸éœ€è¦æ˜¾ç¤º
    fi
}

# Telegramé€šçŸ¥ (ä¼˜åŒ–ç‰ˆï¼Œæ ¹æ®ç³»ç»ŸçŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè´Ÿè½½å’Œå†…å­˜)
send_telegram_notification() {
    local title="$1"
    local message="$2"
    local emoji="$3"
    local formatted_message=$(echo -e "$message" | sed 's/^/- /')
    local current_time=$(date '+%F %T')
    local server_info="$REMOTE_DIR_NAME"
    
    # è·å–ç³»ç»ŸçŠ¶æ€
    read -r system_load memory_usage load_threshold <<< "$(get_system_status)"
    
    local system_info=""
    if should_show_system_status "$system_load" "$memory_usage" "$load_threshold"; then
        # åªæœ‰åœ¨è´Ÿè½½æˆ–å†…å­˜è¿‡é«˜æ—¶æ‰æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        local cpu_cores=$(nproc 2>/dev/null || echo "1")
        system_info="\n- è´Ÿè½½: \`${system_load}\` (${cpu_cores}æ ¸) $(echo "$system_load > $load_threshold" | bc -l 2>/dev/null | grep -q 1 && echo "âš ï¸" || echo "")"
        system_info="${system_info}\n- å†…å­˜: \`${memory_usage}%\` $([ "$memory_usage" -gt "$MEMORY_THRESHOLD" ] && echo "âš ï¸" || echo "")"
    fi
    
    local payload="{\"chat_id\":\"$CHAT_ID\",\"text\":\"${emoji} *${title}* | \`$server_info\`\n\n${formatted_message}${system_info}\n- æ—¶é—´: \`${current_time}\`\",\"parse_mode\":\"Markdown\"}"
    
    retry_command "curl -s -X POST 'https://api.telegram.org/bot$BOT_TOKEN/sendMessage' -H 'Content-Type: application/json' -d '$payload' >/dev/null"
}

# systemdå®šæ—¶å™¨è®¾ç½® (ä¿®å¤æ—¶é—´æ˜¾ç¤ºé—®é¢˜)
setup_systemd_timer() {
    local service_file="/etc/systemd/system/system-snapshot.service"
    local timer_file="/etc/systemd/system/system-snapshot.timer"
    
    if [ -f "$timer_file" ]; then
        systemctl stop system-snapshot.timer 2>/dev/null || true
    fi

    cat > "$service_file" << EOFSERVICE
[Unit]
Description=System Snapshot Backup Service
After=network.target
[Service]
Type=oneshot
ExecStart=$(realpath "$0")
Environment="SYSTEMD_TIMER=1"
WorkingDirectory=/root
[Install]
WantedBy=multi-user.target
EOFSERVICE
    
    cat > "$timer_file" << EOFTIMER
[Unit]
Description=Run System Snapshot Every $BACKUP_INTERVAL_DAYS Days
[Timer]
OnActiveSec=1h
OnUnitActiveSec=${BACKUP_INTERVAL_DAYS}d
RandomizedDelaySec=2h
Persistent=true
[Install]
WantedBy=timers.target
EOFTIMER
    
    systemctl daemon-reload
    systemctl enable system-snapshot.timer
    systemctl start system-snapshot.timer
    
    # ç®€å•ç›´æ¥çš„æ—¶é—´è®¡ç®—ï¼ˆé¿å…systemdè§£æé—®é¢˜ï¼‰
    local current_time=$(date +%s)
    local next_run_time=$((current_time + 3600))  # å½“å‰æ—¶é—´ + 1å°æ—¶
    local next_run_cst=$(date -d "@$next_run_time" '+%Yå¹´%mæœˆ%dæ—¥ %H:%M (CST)')
    
    log_info "å®šæ—¶å™¨å·²è®¾ç½®: 1å°æ—¶åé¦–æ¬¡è¿è¡Œï¼Œä¹‹åæ¯${BACKUP_INTERVAL_DAYS}å¤©æ‰§è¡Œä¸€æ¬¡"
    log_info "è®¡ç®—å¾—å‡ºçš„ä¸‹æ¬¡è¿è¡Œæ—¶é—´: $next_run_cst"
    
    send_telegram_notification "å®šæ—¶ä»»åŠ¡æ›´æ–°" "é¢‘ç‡: 1å°æ—¶åé¦–æ¬¡è¿è¡Œï¼Œä¹‹åæ¯${BACKUP_INTERVAL_DAYS}å¤©ä¸€æ¬¡\nä¸‹æ¬¡è¿è¡Œ: ${next_run_cst}" "â°"
}

# åˆ›å»ºå¿«ç…§ (å¢åŠ è€—æ—¶ç»Ÿè®¡)
create_snapshot() {
    local start_time=$(date +%s)
    log_info "å¼€å§‹åˆ›å»ºç³»ç»Ÿå¿«ç…§..."
    send_telegram_notification "å¼€å§‹åˆ›å»ºå¿«ç…§" "ä»»åŠ¡å·²å¯åŠ¨" "ğŸ”„"
    
    check_disk_space || return 1
    
    # ä½¿ç”¨pigzå¦‚æœå¯ç”¨
    local compress_cmd="gzip"
    if command -v pigz >/dev/null; then
        compress_cmd="pigz"
        log_info "ä½¿ç”¨ pigz å¤šçº¿ç¨‹å‹ç¼©"
    fi
    
    cd / && tar -cf - \
        --exclude="dev/*" --exclude="proc/*" --exclude="sys/*" --exclude="tmp/*" \
        --exclude="run/*" --exclude="mnt/*" --exclude="media/*" --exclude="lost+found" \
        --exclude="var/cache/*" --exclude="var/tmp/*" --exclude="var/log/*" \
        --exclude="var/lib/apt/lists/*" --exclude="var/lib/docker/*" \
        --exclude="$BACKUP_DIR/*" --exclude="*.log" --exclude="*.tmp" \
        --exclude="swap*" --exclude="core" --exclude=".cache/*" \
        --warning=no-file-changed \
        etc usr var root home opt 2>/tmp/snapshot_error.log | $compress_cmd > "$SNAPSHOT_FILE"
    
    if [ ! -f "$SNAPSHOT_FILE" ] || [ ! -s "$SNAPSHOT_FILE" ]; then
        local error_msg=$(cat /tmp/snapshot_error.log 2>/dev/null || echo "æœªçŸ¥é”™è¯¯")
        log_error "å¿«ç…§åˆ›å»ºå¤±è´¥: $error_msg"
        send_telegram_notification "ç³»ç»Ÿå¿«ç…§å¤±è´¥" "é”™è¯¯: \`$error_msg\`" "âŒ"
        return 1
    fi
    
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local snapshot_size=$(du -h "$SNAPSHOT_FILE" | cut -f1)
    
    # æ­£ç¡®çš„æ–‡ä»¶åå¤„ç† (çº¯bashå­—ç¬¦ä¸²æ“ä½œ)
    local snapshot_name_short="${SNAPSHOT_FILE##*/}"
    snapshot_name_short="${snapshot_name_short%%.tar.gz}"
    snapshot_name_short="${snapshot_name_short#system_snapshot_}"
    snapshot_name_short="${snapshot_name_short:0:8}-${snapshot_name_short:8:4}"
    
    log_info "å¿«ç…§åˆ›å»ºæˆåŠŸ: $SNAPSHOT_FILE ($snapshot_size, è€—æ—¶: ${duration}s)"
    send_telegram_notification "ç³»ç»Ÿå¿«ç…§åˆ›å»ºæˆåŠŸ" "å¿«ç…§æ–‡ä»¶: \`$snapshot_name_short\`\næ–‡ä»¶å¤§å°: \`$snapshot_size\`\nåˆ›å»ºè€—æ—¶: \`${duration}ç§’\`" "ğŸ“¸"
}

# æ¸…ç†æœ¬åœ°æ—§å¿«ç…§
cleanup_local() {
    log_info "æ¸…ç†æœ¬åœ°æ—§å¿«ç…§..."
    find "$BACKUP_DIR" -maxdepth 1 -type f -name "system_snapshot_*.tar.gz" | sort -r | tail -n +$((LOCAL_SNAPSHOT_KEEP+1)) | xargs -r rm -f
}

# ä¸Šä¼ åˆ°è¿œç¨‹ (å¢åŠ è€—æ—¶å’Œé€Ÿåº¦ç»Ÿè®¡)
upload_snapshot() {
    log_info "å¼€å§‹ä¸Šä¼ å¿«ç…§åˆ°è¿œç¨‹æœåŠ¡å™¨..."
    send_telegram_notification "å¼€å§‹è¿œç¨‹ä¸Šä¼ " "ä»»åŠ¡å·²å¯åŠ¨" "â¬†ï¸"
    
    if ! retry_command "ssh -p '$SSH_PORT' -o ConnectTimeout=10 -o BatchMode=yes '$TARGET_USER@$TARGET_IP' 'echo è¿æ¥æµ‹è¯•' >/dev/null"; then
        log_error "æ— æ³•è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨"
        send_telegram_notification "è¿œç¨‹ä¸Šä¼ å¤±è´¥" "åŸå› : æ— æ³•è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨" "âš ï¸"
        return 1
    fi
    
    local upload_start_time=$(date +%s)
    local snapshot_size_bytes=$(du -b "$SNAPSHOT_FILE" | cut -f1)
    
    if retry_command "rsync -avz --timeout=300 -e 'ssh -p $SSH_PORT' '$SNAPSHOT_FILE' '$TARGET_USER@$TARGET_IP:$FULL_REMOTE_PATH/system_snapshots/'"; then
        local upload_end_time=$(date +%s)
        local upload_duration=$((upload_end_time - upload_start_time))
        
        # é¿å…é™¤é›¶é”™è¯¯
        local upload_speed="N/A"
        if [ "$upload_duration" -gt 0 ]; then
            local upload_speed_bps=$((snapshot_size_bytes / upload_duration))
            upload_speed="$(format_bytes $upload_speed_bps)/s"
        fi
        
        # æ­£ç¡®çš„æ–‡ä»¶åå¤„ç†
        local snapshot_name_short="${SNAPSHOT_FILE##*/}"
        snapshot_name_short="${snapshot_name_short%%.tar.gz}"
        snapshot_name_short="${snapshot_name_short#system_snapshot_}"
        snapshot_name_short="${snapshot_name_short:0:8}-${snapshot_name_short:8:4}"
        
        local display_remote_path=${FULL_REMOTE_PATH/#\/home\/$TARGET_USER/\~}
        
        log_info "å¿«ç…§ä¸Šä¼ æˆåŠŸ"
        send_telegram_notification "è¿œç¨‹ä¸Šä¼ æˆåŠŸ" "å·²æˆåŠŸä¸Šä¼ å¿«ç…§: \`$snapshot_name_short\`\nè¿œç¨‹è·¯å¾„: \`${display_remote_path}\`\nä¸Šä¼ è€—æ—¶: \`${upload_duration}ç§’\`\nä¼ è¾“é€Ÿåº¦: \`${upload_speed}\`" "âœ…"
        
        # æ¸…ç†è¿œç¨‹æ—§å¿«ç…§
        ssh -p "$SSH_PORT" "$TARGET_USER@$TARGET_IP" "find $FULL_REMOTE_PATH/system_snapshots -type f -name '*.tar.gz' -mtime +$REMOTE_SNAPSHOT_DAYS -delete"
    else
        log_error "å¿«ç…§ä¸Šä¼ å¤±è´¥"
        send_telegram_notification "è¿œç¨‹ä¸Šä¼ å¤±è´¥" "é”™è¯¯: rsyncä¼ è¾“å¤±è´¥" "âŒ"
    fi
}

# ä¸»æ‰§è¡Œæµç¨‹
if [ -z "$SYSTEMD_TIMER" ]; then
    setup_systemd_timer
fi

create_snapshot && cleanup_local && upload_snapshot

log_info "ç³»ç»Ÿå¿«ç…§æ“ä½œå…¨éƒ¨å®Œæˆ"

# ç»Ÿè®¡ä¿¡æ¯ (ç»Ÿä¸€å¤§å°æ˜¾ç¤ºæ ¼å¼)
TOTAL_LOCAL_SNAPSHOTS=$(find "$BACKUP_DIR" -maxdepth 1 -type f -name "system_snapshot_*.tar.gz" | wc -l)

# ä½¿ç”¨å¤šç§æ–¹æ³•å°è¯•è·å–æœ¬åœ°æ–‡ä»¶æ€»å¤§å°
if [ "$TOTAL_LOCAL_SNAPSHOTS" -gt 0 ]; then
    # ä¼˜å…ˆä½¿ç”¨ du å‘½ä»¤
    TOTAL_LOCAL_SIZE_BYTES=$(find "$BACKUP_DIR" -maxdepth 1 -type f -name "system_snapshot_*.tar.gz" -exec du -b {} + 2>/dev/null | awk '{sum+=$1} END {print sum+0}')
    
    # å¦‚æœ du -b ä¸æ”¯æŒï¼Œå°è¯•ä½¿ç”¨ wc -c
    if [ "$TOTAL_LOCAL_SIZE_BYTES" = "0" ] || [ -z "$TOTAL_LOCAL_SIZE_BYTES" ]; then
        TOTAL_LOCAL_SIZE_BYTES=$(find "$BACKUP_DIR" -maxdepth 1 -type f -name "system_snapshot_*.tar.gz" -exec wc -c {} + 2>/dev/null | tail -n 1 | awk '{print $1}' || echo '0')
    fi
    
    # æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ stat å‘½ä»¤
    if [ "$TOTAL_LOCAL_SIZE_BYTES" = "0" ] || [ -z "$TOTAL_LOCAL_SIZE_BYTES" ]; then
        TOTAL_LOCAL_SIZE_BYTES=$(find "$BACKUP_DIR" -maxdepth 1 -type f -name "system_snapshot_*.tar.gz" -exec stat -c%s {} + 2>/dev/null | awk '{sum+=$1} END {print sum+0}' || echo '0')
    fi
else
    TOTAL_LOCAL_SIZE_BYTES=0
fi

TOTAL_LOCAL_SIZE=$(format_bytes "$TOTAL_LOCAL_SIZE_BYTES")

# è·å–æœ¬æ¬¡å¿«ç…§å¤§å°ï¼ˆä½¿ç”¨ä¸æ€»å¤§å°ç›¸åŒçš„æ–¹æ³•ç¡®ä¿ä¸€è‡´æ€§ï¼‰
if [ -f "$SNAPSHOT_FILE" ]; then
    SNAPSHOT_SIZE_BYTES=$(du -b "$SNAPSHOT_FILE" 2>/dev/null | cut -f1 || wc -c < "$SNAPSHOT_FILE" 2>/dev/null || echo "0")
    SNAPSHOT_SIZE=$(format_bytes "$SNAPSHOT_SIZE_BYTES")
else
    SNAPSHOT_SIZE="N/A"
fi

# è·å–ç£ç›˜ä½¿ç”¨ç‡
DISK_USAGE=$(df "$BACKUP_DIR" 2>/dev/null | tail -n 1 | awk '{print $5}' | sed 's/%//' || echo "N/A")

REPORT_MESSAGE="æœ¬æ¬¡å¿«ç…§å¤§å°: \`${SNAPSHOT_SIZE:-N/A}\`\næœ¬åœ°å¿«ç…§æ•°é‡: \`${TOTAL_LOCAL_SNAPSHOTS}\`ä¸ª\næœ¬åœ°æ€»å¤§å°: \`${TOTAL_LOCAL_SIZE}\`\nç£ç›˜ä½¿ç”¨ç‡: \`${DISK_USAGE}%\`"

if ssh -p "$SSH_PORT" -o ConnectTimeout=5 -o BatchMode=yes "$TARGET_USER@$TARGET_IP" "true" >/dev/null 2>&1; then
    # è·å–è¿œç¨‹å¿«ç…§ç»Ÿè®¡ä¿¡æ¯ (ä¿®å¤ç§‘å­¦è®¡æ•°æ³•é—®é¢˜)
    REMOTE_STATS=$(ssh -p "$SSH_PORT" "$TARGET_USER@$TARGET_IP" "
        if [ -d '$FULL_REMOTE_PATH/system_snapshots' ]; then
            cd '$FULL_REMOTE_PATH/system_snapshots'
            
            # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
            COUNT=\$(find . -name '*.tar.gz' 2>/dev/null | wc -l)
            
            if [ \"\$COUNT\" -gt 0 ]; then
                # ä½¿ç”¨ du å‘½ä»¤å¹¶å¼ºåˆ¶è¾“å‡ºæ•´æ•°æ ¼å¼
                TOTAL_BYTES=\$(du -bc *.tar.gz 2>/dev/null | tail -n 1 | awk '{printf \"%.0f\", \$1}' || echo '0')
                
                # å¦‚æœ du å¤±è´¥ï¼Œä½¿ç”¨ ls æ–¹æ³•
                if [ \"\$TOTAL_BYTES\" = \"0\" ] || [ -z \"\$TOTAL_BYTES\" ]; then
                    TOTAL_BYTES=\$(ls -la *.tar.gz 2>/dev/null | awk 'NF>=5 {sum+=\$5} END {printf \"%.0f\", sum+0}')
                fi
                
                # æœ€åå¤‡é€‰ï¼šå•ä¸ªæ–‡ä»¶ç´¯åŠ 
                if [ \"\$TOTAL_BYTES\" = \"0\" ] || [ -z \"\$TOTAL_BYTES\" ]; then
                    TOTAL_BYTES=0
                    for file in *.tar.gz; do
                        if [ -f \"\$file\" ]; then
                            size=\$(wc -c < \"\$file\" 2>/dev/null || echo '0')
                            TOTAL_BYTES=\$((TOTAL_BYTES + size))
                        fi
                    done
                fi
            else
                TOTAL_BYTES=0
            fi
            echo \"\$COUNT \$TOTAL_BYTES\"
        else
            echo '0 0'
        fi
    " 2>/dev/null)
    
    read -r REMOTE_COUNT REMOTE_SIZE_BYTES <<< "$REMOTE_STATS"
    
    # é¢å¤–å¤„ç†ï¼šå¦‚æœè¿˜æ˜¯ç§‘å­¦è®¡æ•°æ³•ï¼Œåœ¨æœ¬åœ°è½¬æ¢
    if [[ "$REMOTE_SIZE_BYTES" =~ [eE] ]]; then
        REMOTE_SIZE_BYTES=$(echo "$REMOTE_SIZE_BYTES" | awk '{printf "%.0f", $1}' 2>/dev/null || echo "0")
    fi
    
    REMOTE_SIZE_FORMATTED=$(format_bytes "${REMOTE_SIZE_BYTES:-0}")
    
    log_info "è¿œç¨‹ç»Ÿè®¡ç»“æœ: æ•°é‡=${REMOTE_COUNT}, å¤§å°=${REMOTE_SIZE_BYTES}å­—èŠ‚ (${REMOTE_SIZE_FORMATTED})"
    
    REPORT_MESSAGE="${REPORT_MESSAGE}\nè¿œç¨‹å¿«ç…§æ•°é‡: \`${REMOTE_COUNT:-0}\`ä¸ª\nè¿œç¨‹æ€»å¤§å°: \`${REMOTE_SIZE_FORMATTED}\`"
else
    REPORT_MESSAGE="${REPORT_MESSAGE}\nè¿œç¨‹æœåŠ¡å™¨æ— æ³•è¿æ¥"
fi

send_telegram_notification "ç³»ç»Ÿå¿«ç…§æ“ä½œå®Œæˆ" "$REPORT_MESSAGE" "âœ…"
EOF

    chmod +x "$SCRIPT_FILE"
    chmod 600 "$CONFIG_FILE"
    log "${GREEN}âœ“ è„šæœ¬åˆ›å»ºå®Œæˆï¼${NC}\n"
}

# ä¸»æµç¨‹
main() {
    clear
    show_title "ç³»ç»Ÿå¿«ç…§å¤‡ä»½å·¥å…·å®‰è£…å‘å¯¼"
    check_requirements
    collect_config
    setup_ssh_key
    test_telegram
    create_script
    if [[ "$RUN_NOW" =~ ^[Yy]$ ]]; then
        log "${YELLOW}æ­£åœ¨æ‰§è¡Œé¦–æ¬¡æµ‹è¯•è¿è¡Œ...${NC}"
        bash "$SCRIPT_FILE"
    fi
    show_title "å®‰è£…å®Œæˆ"
    log "${GREEN}âœ“ ç³»ç»Ÿå¿«ç…§å¤‡ä»½å·¥å…·å®‰è£…æˆåŠŸï¼${NC}\n"
    log "${CYAN}é…ç½®æ–‡ä»¶ä½ç½®:${NC} $CONFIG_FILE"
    log "${CYAN}ä¸»è„šæœ¬ä½ç½®:${NC} $SCRIPT_FILE"
    echo
    log "${YELLOW}è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç®¡ç†å®šæ—¶ä»»åŠ¡:${NC}"
    log "  - æŸ¥çœ‹çŠ¶æ€: ${CYAN}sudo systemctl status system-snapshot.timer${NC}"
    log "  - ç«‹å³è¿è¡Œ: ${CYAN}sudo systemctl start system-snapshot.service${NC}"
    log "  - åœæ­¢/ç¦ç”¨: ${CYAN}sudo systemctl disable system-snapshot.timer${NC}"
    echo
    log "${BLUE}å¦‚éœ€é‡æ–°é…ç½®å®šæ—¶å™¨ï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶åæ‰‹åŠ¨è¿è¡Œä¸€æ¬¡ä¸»è„šæœ¬å³å¯è‡ªåŠ¨æ›´æ–°ã€‚${NC}"
    echo
}

# è¿è¡Œä¸»ç¨‹åº
main
